

# PfSense Konfigurationsstrategie für Dual-WAN mit VLANs und Failover

Diese Konfigurationsstrategie beschreibt die erforderlichen Schritte und Features, um eine pfSense-Firewall mit zwei Internet-Anschlüssen (DSL und Glasfaser) und mehreren VLANs zu konfigurieren, wobei ein automatisches Failover sichergestellt wird und bestimmte Abteilungen bevorzugten Zugang zum schnelleren Glasfaseranschluss erhalten.

## Netzwerkarchitektur

Zunächst ist es wichtig, die Netzwerkarchitektur zu verstehen:

- WAN1: Glasfaseranschluss (primär, höhere Bandbreite)
    
- WAN2: DSL-Anschluss (Backup)
    
- Mehrere VLANs für verschiedene Abteilungen (z.B. IT, Verwaltung, Produktion, Gäste)
    
- pfSense-Firewall als zentrale Routing- und Sicherheitskomponente
    

## VLAN-Konfiguration

Der erste Schritt ist die Konfiguration der notwendigen VLANs in pfSense:

1. **VLAN-Definition**:
    
    - Navigation zu **Interfaces** > **Assignments** > **VLANs**
        
    - Für jede Abteilung ein VLAN erstellen (z.B. VLAN 10 für IT, VLAN 20 für Verwaltung)[12](https://docs.netgate.com/pfsense/en/latest/recipes/switch-vlan-configuration.html)
        
    - Jedem VLAN eine eindeutige ID und Beschreibung zuweisen
        
2. **Interface-Zuweisung**:
    
    - Navigation zu **Interfaces** > **Assignments**
        
    - Jedem konfigurierten VLAN ein Interface zuweisen (z.B. VLAN10 wird OPT1)
        
    - Jedes Interface aktivieren und konfigurieren (IP-Adresse, Subnetzmaske, Beschreibung)[12](https://docs.netgate.com/pfsense/en/latest/recipes/switch-vlan-configuration.html)
        
3. **DHCP-Server einrichten**:
    
    - Für jedes VLAN-Interface einen DHCP-Server konfigurieren
        
    - Navigation zu **Services** > **DHCP Server**
        
    - IP-Bereich, Gateway, DNS-Server und Lease-Zeit festlegen[7](https://www.reddit.com/r/PFSENSE/comments/1ae7ilo/complete_vlan_setup_guide_for_pfsense_switch/)
        

## WAN-Schnittstellen Konfiguration

Konfiguration der beiden WAN-Schnittstellen:

1. **WAN1 (Glasfaser)**:
    
    - Konfiguration der primären WAN-Schnittstelle mit entsprechenden Einstellungen
        
    - Navigation zu **Interfaces** > **WAN**
        
    - IP-Konfiguration gemäß Provider-Vorgaben (DHCP, statische IP)
        
2. **WAN2 (DSL)**:
    
    - Konfiguration der sekundären WAN-Schnittstelle
        
    - Navigation zu **Interfaces** > **(OPTx für WAN2)**
        
    - IP-Konfiguration gemäß Provider-Vorgaben
        
    - Interface auf "WAN-Typ" setzen[2](https://www.provya.com/blog/pfsense-multiple-wan-connections/)
        

## Gateway-Monitoring konfigurieren

Um ein zuverlässiges Failover zu gewährleisten, muss ein effektives Gateway-Monitoring eingerichtet werden:

1. **Gateway-Einrichtung**:
    
    - Navigation zu **System** > **Routing** > **Gateways**
        
    - Für beide WAN-Verbindungen Gateway-Einträge erstellen oder überprüfen[1](https://docs.netgate.com/pfsense/en/latest/multiwan/load-balance-and-failover.html)
        
2. **Monitoring-Parameter**:
    
    - Für jedes Gateway Monitoring-IPs festlegen (z.B. `8.8.8.8` und `1.1.1.1`)
        
    - Überwachungsintervall und Schwellenwerte für Paketverlust und Latenz festlegen
        
    - Empfohlene Werte: Monitor-IP-Adresse außerhalb des eigenen Netzes, Überwachungsintervall 1-2 Sekunden[17](https://bobcares.com/blog/pfsense-wan-failover/)
        
3. **Advanced Gateway Settings**:
    
    - Navigation zu **System** > **Advanced** > **Misc**
        
    - Entsprechende Optionen für "State Killing on Gateway Recovery" konfigurieren, um das Verhalten bei Gateway-Recovery zu steuern[6](https://www.netgate.com/blog/netgate-to-enhance-gateway-recovery-in-pfsense-plus-version-24.03)
        

## Gateway-Gruppen für Failover einrichten

Gateway-Gruppen ermöglichen die Implementierung des Failover-Mechanismus:

1. **Failover-Gruppe erstellen**:
    
    - Navigation zu **System** > **Routing** > **Gateway Groups**
        
    - Neue Gruppe hinzufügen (z.B. "WAN_FAILOVER")
        
    - Glasfaser-Gateway als Tier 1 (höchste Priorität) und DSL-Gateway als Tier 2 konfigurieren
        
    - Trigger-Level auf den gewünschten Wert setzen (z.B. "Member Down")[9](https://docs.netgate.com/pfsense/en/latest/routing/gateway-groups.html)13
        
2. **Default Gateway konfigurieren**:
    
    - Navigation zu **System** > **Routing**
        
    - Als IPv4-Standardgateway die erstellte Failover-Gruppe "WAN_FAILOVER" auswählen[14](https://forums.lawrencesystems.com/t/pfsense-multi-wan-failover-blocks-inter-vlan-access/15492)
        

## Policy-Based Routing für spezifische VLANs

Um bestimmten VLANs (wie der IT-Abteilung) bevorzugten Zugang zum Glasfaseranschluss zu gewähren:

1. **Gateway-Gruppe für IT-VLAN**:
    
    - Separate Gateway-Gruppe für IT erstellen (z.B. "IT_WAN_GROUP")
        
    - Glasfaser-Gateway als Tier 1 konfigurieren
        
    - DSL-Gateway als Tier 2 für Failover-Zwecke konfigurieren3
        
2. **Policy-Based Routing einrichten**:
    
    - Navigation zu **Firewall** > **Rules** > **(VLAN-Interface)**
        
    - Firewall-Regeln für das IT-VLAN erstellen, die speziell das Glasfaser-Gateway verwenden
        
    - Bei "Gateway" die entsprechende Gateway-Gruppe auswählen3[11](https://www.reddit.com/r/PFSENSE/comments/15b37fw/allow_one_vlan_to_use_second_wan_but_not_another/)
        

## Firewall-Regeln konfigurieren

Firewall-Regeln müssen konfiguriert werden, um den Verkehr korrekt zu lenken:

1. **WAN-Regeln**:
    
    - Für beide WAN-Schnittstellen Regeln erstellen, die unerwünschten eingehenden Verkehr blockieren
        
    - Notwendige Dienste (z.B. VPN) auf den entsprechenden Ports zulassen
        
2. **VLAN-Regeln**:
    
    - Für jedes VLAN Regeln erstellen, die den ausgehenden Verkehr über die entsprechende Gateway-Gruppe leiten
        
    - Für das IT-VLAN: Regel mit hoher Priorität erstellen, die den Glasfaser-Anschluss verwendet
        
    - Für andere VLANs: Regeln mit der allgemeinen Failover-Gruppe erstellen[14](https://forums.lawrencesystems.com/t/pfsense-multi-wan-failover-blocks-inter-vlan-access/15492)
        
3. **Inter-VLAN Kommunikation**:
    
    - Regeln für die Kommunikation zwischen VLANs erstellen
        
    - Wichtig: Diese Regeln müssen vor den Gateway-spezifischen Regeln platziert werden, um sicherzustellen, dass interner Verkehr nicht über WAN geleitet wird[14](https://forums.lawrencesystems.com/t/pfsense-multi-wan-failover-blocks-inter-vlan-access/15492)
        

## NAT-Konfiguration

Outbound NAT muss konfiguriert werden, um sicherzustellen, dass Verkehr über das richtige WAN-Interface geleitet wird:

1. **NAT-Modus konfigurieren**:
    
    - Navigation zu **Firewall** > **NAT** > **Outbound**
        
    - "Hybrid Outbound NAT" oder "Manual Outbound NAT" auswählen3
        
2. **NAT-Regeln erstellen**:
    
    - Für jedes VLAN entsprechende NAT-Regeln erstellen
        
    - Für das IT-VLAN: NAT-Regel erstellen, die den Glasfaser-Anschluss verwendet
        
    - Für andere VLANs: NAT-Regeln mit der allgemeinen Failover-Gruppe erstellen3
        

## Optimierung für Session-Stabilität

Um die Stabilität von bestehenden Sitzungen beim Failover zu gewährleisten:

1. **Sticky Connections konfigurieren**:
    
    - Navigation zu **System** > **Advanced** > **Misc**
        
    - "Sticky Connections" evaluieren (kann je nach Anwendungsfall hilfreich sein, hat aber auch Nachteile wie in[8](https://blog.stefcho.eu/multi-wan-with-pfsense-https-sites-issue/) beschrieben)
        
2. **State Handling konfigurieren**:
    
    - Bei neueren pfSense Plus Versionen (24.03 und höher): "State Killing on Gateway Recovery" konfigurieren
        
    - Option "Keep Failover States" wählen, um Sessions stabil zu halten[6](https://www.netgate.com/blog/netgate-to-enhance-gateway-recovery-in-pfsense-plus-version-24.03)
        

## Überprüfung und Tests

Nach Abschluss der Konfiguration sollten folgende Tests durchgeführt werden:

1. **Konnektivitätstests**:
    
    - Von jedem VLAN aus die Internet-Konnektivität überprüfen
        
    - Überprüfen, ob das IT-VLAN tatsächlich den Glasfaseranschluss verwendet
        
2. **Failover-Tests**:
    
    - WAN1 (Glasfaser) deaktivieren und beobachten, ob der Verkehr automatisch über WAN2 (DSL) geleitet wird
        
    - Aktive Verbindungen überwachen, um die Session-Stabilität zu überprüfen
        
    - WAN1 wieder aktivieren und prüfen, ob der Verkehr entsprechend zurückgeleitet wird13
        
3. **Inter-VLAN Kommunikationstests**:
    
    - Überprüfen, ob die Kommunikation zwischen VLANs auch während eines Failovers funktioniert[14](https://forums.lawrencesystems.com/t/pfsense-multi-wan-failover-blocks-inter-vlan-access/15492)
        

## Fazit

Diese Konfigurationsstrategie ermöglicht ein zuverlässiges automatisches Failover zwischen zwei WAN-Verbindungen, während bestimmte VLANs bevorzugten Zugang zum Glasfaseranschluss erhalten. Die Session-Stabilität wird durch entsprechende Konfiguration der Gateway-Gruppen und State-Handling-Optionen gewährleistet, und die Stateful Firewall-Funktionalität bleibt unbeeinträchtigt.

Die Kombination aus Gateway-Gruppen, Policy-Based Routing und sorgfältig konfigurierten Firewall- und NAT-Regeln sorgt für ein robustes und flexibles Netzwerk, das den Anforderungen der fiktiven Firma gerecht wird.

# Erweiterung der PfSense-Konfiguration um Zero-Trust-Prinzipien

## Grundlagen der Zero-Trust-Integration

Die Implementierung einer Zero-Trust-Architektur in pfSense erfordert eine tiefgreifende Erweiterung der vorhandenen Sicherheitsmechanismen. Kernprinzipien sind:

- **Kein implizites Vertrauen**: Jeder Zugriffsversuch muss unabhängig von Herkunft oder Netzwerksegment verifiziert werden[2](https://www.cerbos.dev/blog/20-open-source-tools-for-zero-trust-architecture)[10](https://support.adamnet.works/t/setting-up-zero-trust-on-pfsense/74)
    
- **Least-Privilege-Zugriff**: Minimal notwendige Rechte für jede Anwendung und jeden Benutzer[14](https://www.zenarmor.com/docs/network-security-tutorials/pfsense-security-and-hardening-best-practice-guide)[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
    
- **Kontinuierliche Verifizierung**: Dynamische Anpassung von Zugriffsrechten basierend auf Kontextfaktoren[15](https://www.reddit.com/r/networking/comments/z9rwla/does_zero_trust_replace_vpn/)
    

## Authentifizierungsschicht

## 1. Mehrstufige Benutzerauthentifizierung

- **RADIUS/LDAP-Integration**:
    
    - Einrichtung eines zentralen Identitätsproviders mit Gruppenpolitiken[3](https://www.reddit.com/r/PFSENSE/comments/13cs6pv/fw_rules_for_a_new_network_infrastructure/)[4](https://www.slideshare.net/slideshow/radius-and-ldap-on-pfsense-24-pfsense-hangout-february-2018/108941526)
        
    - Feingranulare Zugriffsregeln basierend auf AD/LDAP-Attributen[3](https://www.reddit.com/r/PFSENSE/comments/13cs6pv/fw_rules_for_a_new_network_infrastructure/)
        
    - Beispielkonfiguration:
        
        bash
        
        `System > User Manager > Authentication Servers Servertype: LDAP Host: 192.168.1.100 Port: 636 Transport: SSL - TCP`
        
- **Zwei-Faktor-Authentifizierung**:
    
    - TOTP-Implementierung für administrative Zugriffe[6](https://www.comparitech.com/blog/vpn-privacy/pfsense-two-factor-authentication/)
        
    - Hardwaretoken-Unterstützung über Yubico OTP[6](https://www.comparitech.com/blog/vpn-privacy/pfsense-two-factor-authentication/)
        
    - Captive Portal mit 2FA für Geräteauthentifizierung[3](https://www.reddit.com/r/PFSENSE/comments/13cs6pv/fw_rules_for_a_new_network_infrastructure/)[6](https://www.comparitech.com/blog/vpn-privacy/pfsense-two-factor-authentication/)
        

## 2. Device Posture Checking

- **Zertifikatsbasierte Geräteauthentifizierung**:
    
    - Automatisierte Zertifikatsausstellung über ACME-Client[11](https://www.ipserverone.info/knowledge-base/generating-certificates-and-users-for-openvpn-on-pfsense/)
        
    - Strict User-CN Matching für OpenVPN-Verbindungen[8](https://www.reddit.com/r/PFSENSE/comments/y6kggv/question_about_openvpn_and_user_certificates/)
        
    - Beispiel für Zertifikatsrotation:
        
        bash
        
        `System > Cert Manager > CAs > Edit Lifetime: 30 Tage Auto-Renewal: 7 Tage vor Ablauf`
        
- **Endpoint Compliance Checks**:
    
    - Integration von osquery für Systemintegritätsprüfungen[2](https://www.cerbos.dev/blog/20-open-source-tools-for-zero-trust-architecture)
        
    - Prüfung von Antivirenstatus und Patchlevel vor Netzwerkzugriff[15](https://www.reddit.com/r/networking/comments/z9rwla/does_zero_trust_replace_vpn/)
        

## Netzwerksegmentierung

## 1. Erweiterte Mikrosegmentierung

- **VLAN-Hierarchie**:
    
    - Hauptsegmente: IT (10), Verwaltung (20), Produktion (30), IoT (40), Gäste (50)
        
    - Subsegmente pro Abteilung mit /28-Subnetzen[7](https://github.com/nixbitcoin/pfSense-guide)[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
        
- **Firewall-Regeloptimierung**:
    
    - Stateful Inspection mit Application Layer Gateway[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
        
    - Protokollspezifische Regeln für Industrial Control Systems[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
        
    - Beispielregel für IT-VLAN:
        
        text
        
        `Aktion: Pass Quelle: IT_VLAN Ziel: WAN Protokoll: TCP/UDP Gateway: IT_WAN_GROUP`
        

## 2. DNS-basierte Zugriffskontrolle

- **Unbound DNS mit RPZ-Filterung**:
    
    - Integration von Threat Intelligence Feeds9[10](https://support.adamnet.works/t/setting-up-zero-trust-on-pfsense/74)
        
    - Dynamische Blocklisten für Malware-Domains[10](https://support.adamnet.works/t/setting-up-zero-trust-on-pfsense/74)
        
    - Beispielkonfiguration:
        
        bash
        
        `Services > DNS Resolver > Advanced RPZ Zone: https://malware.domains/list.txt Update Interval: 3600`
        
- **DNS over HTTPS/TLS**:
    
    - Erzwingung verschlüsselter DNS-Abfragen9
        
    - Zertifikatspinning für DNS-Resolver[14](https://www.zenarmor.com/docs/network-security-tutorials/pfsense-security-and-hardening-best-practice-guide)
        

## Dynamische Zugriffskontrolle

## 1. Kontextbasierte Firewalling

- **Zeitgesteuerte Regeln**:
    
    - Zugriffsbeschränkungen außerhalb der Geschäftszeiten[14](https://www.zenarmor.com/docs/network-security-tutorials/pfsense-security-and-hardening-best-practice-guide)
        
    - Dynamische Anpassung bei SIEM-Alarmen[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
        
- **Geo-Fencing**:
    
    - Blockierung von Ländern mit hohem Angriffspotenzial[14](https://www.zenarmor.com/docs/network-security-tutorials/pfsense-security-and-hardening-best-practice-guide)
        
    - Whitelisting für kritische Infrastruktur[10](https://support.adamnet.works/t/setting-up-zero-trust-on-pfsense/74)
        

## 2. Intrusion Prevention System

- **Snort-Integration**:
    
    - Echtzeitanalyse des Datenverkehrs mit Suricata[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
        
    - Automatisierte Quarantäne infizierter Endgeräte[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
        
    - Beispielregel:
        
        bash
        
        `Services > Intrusion Detection > Rules Enable: Emerging Threats Pro Block Offenders: Automatically`
        

## Session Management

## 1. Stateful Inspection Optimization

- **Adaptive Session Timeouts**:
    
    - Dynamische Anpassung basierend auf Anwendungstyp[10](https://support.adamnet.works/t/setting-up-zero-trust-on-pfsense/74)
        
    - TCP-Stream-Reassembly für Deep Packet Inspection[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
        
- **Sticky Connections**:
    
    - MAC-Adressbindung für kritische Systeme[10](https://support.adamnet.works/t/setting-up-zero-trust-on-pfsense/74)
        
    - QoS-Markierung für VoIP-Sessions[7](https://github.com/nixbitcoin/pfSense-guide)
        

## 2. Kontinuierliche Überwachung

- **ELK-Stack-Integration**:
    
    - Zentralisierte Loganalyse mit Grafana-Dashboards[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
        
    - Machine-Learning-basierte Anomalieerkennung[2](https://www.cerbos.dev/blog/20-open-source-tools-for-zero-trust-architecture)
        
- **Real-Time Alerting**:
    
    - Telegram-Integration für kritische Ereignisse[14](https://www.zenarmor.com/docs/network-security-tutorials/pfsense-security-and-hardening-best-practice-guide)
        
    - SNMP-Trapping für Netzwerkgeräte[7](https://github.com/nixbitcoin/pfSense-guide)
        

## Failover-Integration

## 1. Zero-Trust-konformes Failover

- **Dual Path Monitoring**:
    
    - BFD-Implementierung für Subsekunden-Failover[7](https://github.com/nixbitcoin/pfSense-guide)
        
    - SLA-Metriken für Application Performance[10](https://support.adamnet.works/t/setting-up-zero-trust-on-pfsense/74)
        
- **Zertifikatsbasierte WAN-Authentifizierung**:
    
    - IPsec mit Let's Encrypt-Zertifikaten[11](https://www.ipserverone.info/knowledge-base/generating-certificates-and-users-for-openvpn-on-pfsense/)
        
    - OCSP-Stapling für Gateway-Verifizierung[8](https://www.reddit.com/r/PFSENSE/comments/y6kggv/question_about_openvpn_and_user_certificates/)
        

## 2. State Synchronization

- **CARP mit XML-RPC-Sync**:
    
    - HA-Cluster-Konfiguration für State Tables[7](https://github.com/nixbitcoin/pfSense-guide)
        
    - AES-256-Verschlüsselung der Sync-Verbindung[14](https://www.zenarmor.com/docs/network-security-tutorials/pfsense-security-and-hardening-best-practice-guide)
        
    - Beispielkonfiguration:
        
        bash
        
        `System > High Availability > CARP Virtual IP: 192.168.1.1 Password: 256-bit AES Key Sync: Firewall Rules, NAT, VPN`
        

## Implementierungsstrategie

## 1. Phasenplan

1. **Basisabsicherung** (Wochen 1-2):
    
    - 2FA für Admin-Zugänge[6](https://www.comparitech.com/blog/vpn-privacy/pfsense-two-factor-authentication/)
        
    - DNS-Filterung implementieren9[10](https://support.adamnet.works/t/setting-up-zero-trust-on-pfsense/74)
        
2. **Segmentierung** (Wochen 3-4):
    
    - VLAN-Mikrosegmentierung[7](https://github.com/nixbitcoin/pfSense-guide)[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
        
    - Application-aware Firewalling[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
        
3. **Dynamische Kontrolle** (Wochen 5-6):
    
    - Context-based Policies[15](https://www.reddit.com/r/networking/comments/z9rwla/does_zero_trust_replace_vpn/)
        
    - Automated Threat Response[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
        

## 2. Validierungsprozess

- **Penetrationstests**:
    
    - Metasploit-Integration für Schwachstellenscans[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
        
    - Red Team/Blue Team Exercises[2](https://www.cerbos.dev/blog/20-open-source-tools-for-zero-trust-architecture)
        
- **Compliance-Checks**:
    
    - CIS-Benchmark-Implementierung[14](https://www.zenarmor.com/docs/network-security-tutorials/pfsense-security-and-hardening-best-practice-guide)
        
    - BSI-Grundschutz-Zertifizierung[14](https://www.zenarmor.com/docs/network-security-tutorials/pfsense-security-and-hardening-best-practice-guide)
        

## Herausforderungen und Lösungen

## 1. Legacy-Systemintegration

- **Proxy ARP für alte Geräte**:
    
    - Isolierung in eigenem VLAN mit beschränkten Regeln[7](https://github.com/nixbitcoin/pfSense-guide)
        
    - Protocol Translation mittels ALG[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
        
- **Industrial Control Systems**:
    
    - Modbus-TCP Deep Inspection[16](https://blog.cyberplural.com/how-to-build-a-robust-defense-in-depth-with-snort-and-pfsense/)
        
    - Time-based Whitelisting[10](https://support.adamnet.works/t/setting-up-zero-trust-on-pfsense/74)
        

## 2. Performance-Optimierung

- **Hardwarebeschleunigung**:
    
    - AES-NI-Aktivierung für VPN[14](https://www.zenarmor.com/docs/network-security-tutorials/pfsense-security-and-hardening-best-practice-guide)
        
    - NIC-Offloading für 10Gbit/s[7](https://github.com/nixbitcoin/pfSense-guide)
        
- **QoS-Priorisierung**:
    
    - Hierarchical Fair Service Curve[7](https://github.com/nixbitcoin/pfSense-guide)
        
    - DSCP-Markierung für kritische Dienste[10](https://support.adamnet.works/t/setting-up-zero-trust-on-pfsense/74)
        

Diese Erweiterung transformiert die pfSense-Infrastruktur in ein adaptives Zero-Trust-System, das kontinuierliche Verifizierung mit hochverfügbarer Netzwerkinfrastruktur verbindet. Durch die Kombination aus granularen Zugriffskontrollen, tiefgehender Paketinspektion und dynamischer Anpassung entsteht ein resilientes Sicherheitsmodell, das den Anforderungen moderner Bedrohungsszenarien gerecht wird



# Integration von Zero Trust in pfSense Multi-WAN-Umgebungen

## I. Einleitung: Integration von Zero Trust in pfSense Multi-WAN-Umgebungen

### Zielsetzung

Die Absicherung moderner Unternehmensnetzwerke erfordert einen Paradigmenwechsel weg von traditionellen, perimeterbasierten Sicherheitsmodellen hin zu dynamischeren und granulareren Ansätzen. Die Zero Trust Architecture (ZTA) bietet ein solches Modell, das auf dem Prinzip "Never Trust, Always Verify" basiert. Dieses Dokument verfolgt das Ziel, eine umfassende technische Anleitung zur Integration der Kernprinzipien und Implementierungsschritte der Zero Trust Architecture in eine pfSense® Multi-WAN-Umgebung bereitzustellen. Es wird detailliert erläutert, wie die leistungsstarken Funktionen von pfSense genutzt werden können, um eine robustere und widerstandsfähigere Netzwerksicherheitsarchitektur aufzubauen, die den Anforderungen moderner Bedrohungslandschaften gerecht wird, selbst in komplexen Szenarien mit mehreren Internetverbindungen. Die Implementierung von ZTA geht über die reine Perimetersicherung hinaus und erfordert eine grundlegende Neubewertung der Vertrauensstellungen innerhalb des Netzwerks.  

### Herausforderung: ZTA und Multi-WAN

Die Kombination von Zero Trust-Prinzipien mit einer Multi-WAN-Konfiguration in pfSense stellt spezifische Herausforderungen dar. Während pfSense robuste Funktionen für Multi-WAN-Szenarien wie Failover und Load Balancing bietet , erfordert die ZTA-Implementierung, dass Sicherheitsrichtlinien, insbesondere granulare Zugriffskontrollen und Segmentierung, konsistent über alle potenziellen Netzwerkpfade hinweg durchgesetzt werden. Ein zentrales Problem ist die Verwaltung der Verbindungszustände (State Table) während eines WAN-Failovers. Bestehende Verbindungen bleiben oft an das ursprüngliche Gateway gebunden, selbst wenn dieses ausfällt oder das primäre Gateway wieder verfügbar wird. Dies kann dazu führen, dass ZTA-Kontrollen umgangen werden oder unerwünschtes Routing-Verhalten auftritt. pfSense bietet zwar Mechanismen wie "State Killing on Gateway Failure" , aber deren Anwendung und die Auswirkungen auf bestehende Sitzungen müssen sorgfältig abgewogen werden. Die automatische Wiederherstellung von Zuständen auf dem primären Gateway nach dessen Wiederverfügbarkeit (Failback) ist eine bekannte Herausforderung. Die erfolgreiche Integration erfordert daher eine sorgfältige Planung der Firewall-Regelarchitektur und ein tiefes Verständnis der Zustandsbehandlung in pfSense Multi-WAN-Umgebungen.  

Die Implementierung von ZTA in einer pfSense-Umgebung bedeutet für Administratoren einen signifikanten Wandel in der Denkweise. Traditionelle Konfigurationen verlassen sich oft auf implizites Vertrauen innerhalb definierter Netzwerkzonen (z.B. LAN vs. WAN, oder zwischen internen VLANs). ZTA hingegen fordert die explizite Verifizierung jedes einzelnen Zugriffsversuchs, unabhängig vom Ursprung oder Ziel. Dies impliziert, dass selbst Standardkonfigurationen, wie die "Default Allow LAN to Any"-Regel oder die Kommunikation zwischen VLANs, unter ZTA-Gesichtspunkten kritisch hinterfragt und durch wesentlich granularere, restriktivere Regeln ersetzt werden müssen. Die Multi-WAN-Komponente fügt eine zusätzliche Komplexitätsebene hinzu, da diese granulare Kontrolle auch dann gewährleistet sein muss, wenn der ausgehende Netzwerkpfad aufgrund eines Failovers wechselt.  

### Struktur des Berichts

Dieser Bericht ist strukturiert, um Administratoren eine schrittweise Anleitung zur Implementierung von ZTA in pfSense Multi-WAN-Umgebungen zu bieten:

1. **Kernprinzipien der ZTA:** Definition der grundlegenden ZTA-Prinzipien und deren Relevanz im pfSense-Kontext.
2. **pfSense-Funktionen für ZTA:** Zuordnung spezifischer pfSense-Features und -Pakete zu den ZTA-Prinzipien.
3. **Mikrosegmentierung:** Detaillierte Strategie zur Netzwerksegmentierung mittels VLANs und Firewall-Regeln.
4. **Least Privilege:** Methoden zur Durchsetzung minimaler Berechtigungen auf Netzwerkebene.
5. **Starke Authentifizierung:** Implementierung robuster Authentifizierungs- und Autorisierungsmechanismen.
6. **Kontinuierliche Überprüfung:** Einsatz von IDS/IPS zur laufenden Überwachung, insbesondere des Ost-West-Traffics.
7. **Logging und Monitoring:** Konfiguration der Protokollierung für umfassende Transparenz.
8. **Integration in Multi-WAN:** Sicherstellung der Richtlinienkonsistenz und Verwaltung der State Tables im Failover-Szenario.
9. **Zusammenfassung und Empfehlungen:** Abschließende Betrachtungen und praktische Ratschläge.

## II. Kernprinzipien der Zero Trust Architektur (ZTA) im pfSense-Kontext

### Grundlagen der ZTA (NIST SP 800-207)

Die Zero Trust Architecture (ZTA) ist ein Cybersecurity-Paradigma, das traditionelle, perimeterbasierte Sicherheitsmodelle durch einen Fokus auf Benutzer, Assets und Ressourcen ersetzt. Es basiert auf der Annahme, dass Bedrohungen sowohl von externen als auch von internen Quellen ausgehen können und dass Vertrauen niemals implizit gewährt werden darf, nur weil sich ein Benutzer oder Gerät innerhalb des vermeintlich "sicheren" Netzwerkperimeters befindet. Das National Institute of Standards and Technology (NIST) hat in seiner Special Publication 800-207 die Kernprinzipien (Tenets) einer ZTA definiert, die als Grundlage für die Planung und Implementierung dienen :  

1. **Alle Datenquellen und Computing-Services sind Ressourcen:** Jedes Element im Netzwerk, von Geräten über Dienste bis hin zu Daten, wird als schützenswerte Ressource betrachtet.  
    
2. **Jegliche Kommunikation wird gesichert, unabhängig vom Netzwerkstandort:** Es gibt keine vertrauenswürdigen Netzwerkzonen. Jede Kommunikation muss authentifiziert und verschlüsselt werden, als ob sie über ein öffentliches Netzwerk liefe.  
    
3. **Zugriff auf einzelne Unternehmensressourcen wird pro Sitzung gewährt:** Vertrauen ist nicht übertragbar oder dauerhaft. Jeder Zugriffsversuch auf eine Ressource erfordert eine erneute Authentifizierung und Autorisierung.  
    
4. **Der Zugriff auf Ressourcen wird durch dynamische Richtlinien bestimmt:** Die Zugriffserlaubnis basiert auf einer kontinuierlichen Bewertung von Kontextinformationen, einschließlich der Identität des Anfragenden, des Zustands des Geräts, des Standorts, der Zeit und des beobachteten Verhaltens. Das Prinzip der geringsten Rechte (Least Privilege) wird angewendet.  
    
5. **Das Unternehmen überwacht und misst die Integrität und Sicherheit aller eigenen und zugehörigen Assets:** Kein Gerät wird als inhärent vertrauenswürdig eingestuft. Der Sicherheitszustand jedes Assets wird kontinuierlich überprüft.  
    
6. **Jegliche Ressourcenauthentifizierung und -autorisierung ist dynamisch und wird strikt durchgesetzt, bevor Zugriff gewährt wird:** Dies ist ein kontinuierlicher Zyklus aus Zugriffserteilung, Überwachung, Bewertung und Anpassung. Starke Authentifizierungsmethoden wie Multi-Faktor-Authentifizierung (MFA) sind integraler Bestandteil.  
    
7. **Das Unternehmen sammelt so viele Informationen wie möglich über den aktuellen Zustand von Assets, Netzwerkinfrastruktur und Kommunikation und nutzt diese zur Verbesserung seiner Sicherheitsposition:** Umfassendes Logging und Monitoring sind entscheidend für die kontinuierliche Verbesserung der Sicherheitsrichtlinien und die Erkennung von Bedrohungen.  
    

Zusammenfassend lässt sich ZTA durch das Mantra "Never Trust, Always Verify" charakterisieren. Es erfordert Least Privilege Access , Mikrosegmentierung zur Begrenzung des potenziellen Schadens ("Blast Radius") , starke, kontextbasierte Authentifizierung und kontinuierliche Überwachung und Validierung.  

### Relevanz für pfSense

Die Implementierung dieser ZTA-Prinzipien in einer pfSense-Umgebung erfordert eine Abkehr von traditionellen Firewall-Konfigurationen. Es bedeutet:

- **Granularität wird zum Schlüssel:** Statt breiter "Allow"-Regeln (z.B. "LAN net to any") müssen hochspezifische Regeln erstellt werden, die nur den exakt benötigten Datenverkehr zwischen definierten Quellen und Zielen über bestimmte Protokolle und Ports zulassen. Dies spiegelt die Prinzipien des Least Privilege und der Mikrosegmentierung wider. pfSense bietet die Werkzeuge hierfür durch seine flexible Firewall-Regel-Engine und die Möglichkeit, Aliase für IPs, Netze und Ports zu definieren , aber die Anwendung muss deutlich restriktiver erfolgen. Das "Default Deny"-Prinzip, bei dem nicht explizit erlaubter Verkehr blockiert wird, wird zur Grundlage jeder Regelbasis auf allen Schnittstellen, einschließlich der internen VLAN-Interfaces.  
    
- **Interne Segmentierung ist entscheidend:** VLANs werden nicht nur zur logischen Trennung, sondern zur aktiven Sicherheitssegmentierung (Mikrosegmentierung) genutzt. Die Kommunikation zwischen diesen Segmenten wird standardmäßig blockiert und nur bei Bedarf explizit und granular freigegeben.  
    
- **Identität wird zentral:** Die Authentifizierung und Autorisierung von Benutzern und Geräten rückt in den Mittelpunkt. pfSense muss mit Identitätsanbietern (RADIUS, LDAP) integriert werden, um starke Authentifizierung für VPNs, Captive Portal oder potenziell 802.1X durchzusetzen.  
    
- **Kontinuierliche Überwachung wird notwendig:** IDS/IPS-Systeme wie Snort oder Suricata müssen nicht nur am WAN-Perimeter, sondern auch auf internen Schnittstellen (VLANs) eingesetzt werden, um den Ost-West-Verkehr zu überwachen und laterale Bewegungen oder interne Bedrohungen zu erkennen. Umfassendes Logging und die Weiterleitung an SIEM-Systeme sind essenziell für die notwendige Transparenz und Analyse.  
    

Obwohl ZTA dynamische Richtlinien und kontinuierliche Neubewertung des Vertrauens fordert , basiert pfSense primär auf statischen Firewall-Regeln. Diese Lücke kann teilweise durch die dynamische Natur von IDS/IPS-Systemen geschlossen werden, die auf Signaturen und Verhaltensanomalien reagieren. Die Integration mit externen SIEM- oder SOAR-Plattformen über Syslog ermöglicht eine weitergehende Analyse und potenziell automatisierte Reaktionen, die über die Kernfähigkeiten von pfSense hinausgehen und dem dynamischen Aspekt von ZTA näherkommen.  

## III. Nutzung von pfSense-Funktionen zur Zero Trust-Implementierung

pfSense bietet eine Vielzahl von integrierten Funktionen und erweiterbaren Paketen, die zur Umsetzung der verschiedenen ZTA-Prinzipien genutzt werden können. Eine systematische Zuordnung dieser Fähigkeiten ist entscheidend für die Planung einer ZTA-Implementierung.

- **Mikrosegmentierung:**
    
    - **VLANs & Schnittstellenzuweisung:** Die grundlegende Technologie zur Schaffung isolierter Netzwerkzonen in pfSense sind Virtual LANs (VLANs). Über **Interfaces > Assignments > VLANs** können VLAN-Tags definiert und einer physischen übergeordneten Schnittstelle ("Parent Interface") zugewiesen werden. Jedes so erstellte VLAN (z.B. `igb0.10` für VLAN 10 auf `igb0`) wird dann einer logischen Schnittstelle (z.B. OPT1, OPT2) unter **Interfaces > Assignments > Interface Assignments** zugewiesen. Dies erfordert zwingend den Einsatz von 802.1Q-fähigen Managed Switches im Netzwerk und kompatible Netzwerkkarten in der pfSense-Hardware. Diese logischen Schnittstellen bilden die Grenzen der Mikrosegmentierung, zwischen denen der Datenverkehr mittels Firewall-Regeln kontrolliert wird.  
        
    - **Firewall-Regeln (Inter-VLAN):** Die eigentliche Durchsetzung der Segmentierung erfolgt durch Firewall-Regeln, die auf den jeweiligen VLAN-Schnittstellen konfiguriert werden. Das ZTA-Prinzip erfordert hier eine "Default Deny"-Haltung, bei der jegliche Kommunikation zwischen VLANs standardmäßig blockiert und nur explizit benötigte Verbindungen erlaubt werden (siehe Abschnitte IV und V).
- **Least Privilege Access:**
    
    - **Granulare Firewall-Regeln:** pfSense ermöglicht die Erstellung sehr spezifischer Firewall-Regeln. Unter **Firewall > Rules** können für jede Schnittstelle Regeln definiert werden, die auf Quelle, Ziel (spezifische IP-Adressen, Subnetze oder Aliase), Protokoll (TCP, UDP, ICMP etc.) und Ports basieren. Die Vermeidung von "any" in diesen Feldern ist ein Kernaspekt der Least Privilege-Umsetzung. Aliase (**Firewall > Aliases**) sind hierbei extrem nützlich, um Gruppen von Hosts, Netzwerken oder Ports zu definieren und die Regelwerke übersichtlich zu halten. Die Standardaktion für nicht explizit erlaubten Verkehr sollte "Block" (verwirft Pakete stillschweigend) oder "Reject" (sendet eine Ablehnungsnachricht) sein.  
        
    - **Zeitbasierte Regeln:** Über die erweiterten Optionen einer Firewall-Regel kann ein Zeitplan (**Schedule**) zugewiesen werden, sodass die Regel nur zu bestimmten Zeiten aktiv ist. Dies ermöglicht eine zeitliche Einschränkung von Berechtigungen.  
        
    - **Management Interface Access Control:** Die Absicherung des Zugriffs auf die pfSense-Weboberfläche und SSH ist entscheidend und wird in Abschnitt V detailliert behandelt.  
        
- **Starke Authentifizierung & Autorisierung:**
    
    - **Identitätsanbieter-Integration:** pfSense kann unter **System > User Manager > Authentication Servers** für die Authentifizierung von Benutzern an externe Verzeichnisdienste angebunden werden. Unterstützt werden RADIUS und LDAP (inklusive Active Directory). Dies ist die Grundlage für die Benutzerauthentifizierung im Captive Portal und bei VPN-Verbindungen.  
        
    - **Captive Portal:** Über **Services > Captive Portal** können Zonen für bestimmte Netzwerkschnittstellen (z.B. Gäste-VLAN, BYOD-VLAN) eingerichtet werden, die eine Authentifizierung erfordern, bevor Internetzugriff gewährt wird. Als Authentifizierungsmethoden können neben einfachen Klick-Bestätigungen oder Voucher-Codes auch die lokale Benutzerdatenbank, RADIUS oder LDAP genutzt werden.  
        
    - **VPN-Authentifizierung:** pfSense unterstützt verschiedene VPN-Technologien wie OpenVPN, IPsec und WireGuard. Für ZTA ist eine starke Authentifizierung entscheidend. OpenVPN und IPsec unterstützen zertifikatsbasierte Authentifizierung , die als sehr sicher gilt. OpenVPN kann zudem über RADIUS eine Multi-Faktor-Authentifizierung (MFA) erzwingen, beispielsweise durch Nutzung des FreeRADIUS-Pakets auf pfSense in Kombination mit OTP-Methoden wie Google Authenticator. WireGuard selbst bietet keine integrierte Benutzerauthentifizierung; die Sicherheit basiert hier primär auf dem Schlüsselaustausch.  
        
    - **802.1X Port-basierte Kontrolle:** Obwohl nicht direkt eine Kernfunktion von pfSense selbst, kann die Firewall als RADIUS-Server (mittels des FreeRADIUS-Pakets) oder Client für eine 802.1X-Implementierung dienen. Dies ermöglicht die Authentifizierung von Geräten direkt am Switch-Port (kabelgebunden) oder Access Point (drahtlos via WPA2/3-Enterprise), bevor überhaupt Zugriff auf ein Netzwerksegment (VLAN) gewährt wird. Dies erfordert 802.1X-fähige Switches und/oder Access Points. Die Konfiguration erfolgt über das FreeRADIUS-Paket oder durch Anbindung an einen externen RADIUS-Server.  
        
- **Kontinuierliche Überprüfung & Bedrohungserkennung:**
    
    - **IDS/IPS (Snort/Suricata):** Diese Systeme können als Pakete über **System > Package Manager** installiert werden. Sie analysieren den Netzwerkverkehr auf Basis von Regelwerken (Signaturen) und können verdächtige Aktivitäten erkennen (IDS) oder aktiv blockieren (IPS). Für ZTA ist es entscheidend, Snort oder Suricata nicht nur auf der WAN-Schnittstelle, sondern auch auf den internen VLAN-Schnittstellen zu aktivieren, um den Ost-West-Verkehr zu überwachen. Die Konfiguration der Instanzen und Regelwerke erfolgt unter **Services > Snort** bzw. **Services > Suricata**.  
        
    - **Logging & Monitoring:** Die Grundlage für jede Überprüfung sind detaillierte Protokolldaten (siehe Abschnitt VIII).
- **Sichtbarkeit & Analyse:**
    
    - **Logging:** pfSense protokolliert Ereignisse aus zahlreichen Quellen: Firewall (erlaubt/blockiert), System (Logins, Änderungen), DHCP, DNS Resolver/Forwarder, VPNs (IPsec, OpenVPN), Captive Portal, IDS/IPS (Snort/Suricata), Gateway-Status etc. Diese Logs sind unter **Status > System Logs** einsehbar.  
        
    - **Remote Syslog / SIEM-Export:** Um die begrenzten lokalen Log-Speicherkapazitäten zu überwinden und eine zentrale Analyse zu ermöglichen, können Logs an externe Syslog-Server oder Security Information and Event Management (SIEM) Systeme gesendet werden. Dies wird unter **Status > System Logs > Settings > Remote Logging Options** konfiguriert. pfSense unterstützt standardmäßig UDP-Syslog; für verschlüsselte Übertragung (TCP/TLS) kann das syslog-ng-Paket genutzt werden.  
        
- **Anwendungssicherheit / Ressourcenschutz:**
    
    - **Reverse Proxy (HAProxy Paket):** Das HAProxy-Paket (**System > Package Manager > Available Packages**) ermöglicht es, pfSense als Reverse Proxy für interne Anwendungen (z.B. Webserver) zu betreiben. Dies schützt die internen Server, da sie nicht direkt aus dem Internet erreichbar sind. HAProxy kann Anfragen basierend auf Hostnamen oder URLs an verschiedene Backend-Server weiterleiten, SSL/TLS-Verschlüsselung terminieren (SSL-Offloading) und Basis-Load-Balancing durchführen. Die Konfiguration erfolgt unter **Services > HAProxy**.  
        

Die folgende Tabelle fasst die Zuordnung der ZTA-Prinzipien zu den pfSense-Funktionen zusammen:

**Tabelle 1: ZTA-Prinzipien und pfSense-Funktionen**

|ZTA-Prinzip|Relevante pfSense Funktion/Paket|Kurze Beschreibung der Anwendung in ZTA|
|:--|:--|:--|
|**Mikrosegmentierung**|VLANs, Schnittstellenzuweisung, Firewall-Regeln (Inter-VLAN)|Erstellung isolierter Netzwerkzonen; strikte Kontrolle des Datenflusses zwischen Zonen (Default Deny).|
|**Least Privilege Access**|Granulare Firewall-Regeln (Quelle, Ziel, Port, Protokoll), Aliase, Zeitbasierte Regeln|Minimierung von Berechtigungen durch hochspezifische Freigaben; zeitliche Einschränkung des Zugriffs.|
||Management Interface Access Control (Firewall-Regeln, HTTPS, Anti-Lockout)|Absicherung des Zugriffs auf die pfSense-Verwaltungsoberfläche selbst nach dem Least-Privilege-Prinzip.|
|**Starke Authentifizierung**|RADIUS/LDAP Integration, Captive Portal, VPN (OpenVPN/IPsec Zertifikate, RADIUS MFA), 802.1X (via FreeRADIUS)|Strenge Identitätsprüfung für Benutzer und Geräte bei Netzwerkzugang, VPN-Verbindungen und Zugriff auf bestimmte Segmente.|
|**Kontinuierliche Überprüfung**|IDS/IPS (Snort/Suricata Pakete), Logging|Laufende Überwachung des Netzwerkverkehrs (Nord-Süd und Ost-West) auf Bedrohungen und Anomalien; Protokollierung als Basis für Analysen.|
|**Sichtbarkeit & Analyse**|Umfassendes Logging (Firewall, System, Dienste), Remote Syslog Export, SIEM-Integration|Erfassung detaillierter Ereignisdaten; Zentralisierung und Analyse der Logs zur Gewährleistung von Transparenz und Erkennung von Mustern/Anomalien.|
|**Sichere Kommunikation**|VPN (IPsec, OpenVPN, WireGuard), HTTPS für GUI/Captive Portal, SSL-Offloading (HAProxy)|Verschlüsselung von Datenübertragungen über unsichere Netze (Internet) und Sicherung der Management-Schnittstellen.|
|**Ressourcenschutz/Anwendungss.**|Reverse Proxy (HAProxy Paket)|Schutz interner Anwendungen durch vorgeschalteten Proxy, Kontrolle des Zugriffs auf Anwendungsebene.|

In Google Sheets exportieren

## IV. Strategie zur Implementierung der Mikrosegmentierung

Mikrosegmentierung ist ein Kernprinzip der Zero Trust Architecture, das darauf abzielt, das Netzwerk in kleinere, isolierte Sicherheitszonen zu unterteilen, um die laterale Ausbreitung von Bedrohungen zu verhindern oder zumindest stark einzuschränken. In pfSense wird dies primär durch die Kombination von VLANs und restriktiven Firewall-Regeln erreicht.  

### VLAN-Zonen Design

Der erste Schritt ist die sorgfältige Planung der Netzwerksegmente (VLANs). Statt großer, monolithischer Netze (wie einem einzigen LAN) sollten Zonen basierend auf Funktion, Vertrauensstufe oder Datensensitivität definiert werden. Mögliche Kriterien für die Segmentierung sind:

- **Funktion:** Trennung von Servern, Benutzer-Workstations, Druckern, VoIP-Telefonen, Management-Systemen.
- **Abteilung:** Eigene Segmente für IT, Personalwesen, Finanzen, Entwicklung etc., falls organisatorische Isolation erforderlich ist.
- **Vertrauensstufe:** Unterscheidung zwischen hochvertrauenswürdigen Systemen (z.B. Domain Controller, Kern-Server), Standard-Benutzergeräten, weniger vertrauenswürdigen Geräten (z.B. BYOD) und potenziell unsicheren Geräten (z.B. IoT).
- **Sicherheitsanforderungen:** Dedizierte Zonen für Systeme mit besonderen Sicherheitsanforderungen oder Compliance-Vorgaben (z.B. PCI-DSS).
- **Zugriffsbereiche:** Separate Netze für Gäste, externe Partner oder DMZ (Demilitarisierte Zone) für öffentlich erreichbare Server.

**Beispielhafte VLAN-Struktur:**

- `VLAN 10`: **SERVER** (Produktionsserver, Datenbanken)
- `VLAN 20`: **IT_ADMIN** (Workstations der IT-Administratoren)
- `VLAN 30`: **CLIENTS_TRUSTED** (Standard Firmen-Laptops/Desktops)
- `VLAN 40`: **IOT_DEVICES** (Sensoren, Kameras, Smart Devices)
- `VLAN 50`: **GUEST_WIFI** (Gäste-WLAN-Zugang)
- `VLAN 60`: **DMZ_WEB** (Öffentlich erreichbare Webserver)
- `VLAN 99`: **MGMT** (Management-Netzwerk für Netzwerkkomponenten, falls getrennt)

Die technische Umsetzung in pfSense erfolgt durch die Definition der VLAN-Tags unter **Interfaces > Assignments > VLANs**, wobei jede VLAN-ID einem physischen "Parent Interface" zugewiesen wird. Anschließend werden diese VLANs unter **Interfaces > Assignments > Interface Assignments** logischen OPT-Schnittstellen (z.B. OPT1, OPT2,...) zugeordnet und aktiviert. Parallel dazu müssen die beteiligten Switches für 802.1Q-Trunking auf den Ports konfiguriert werden, die mit der pfSense-Firewall und untereinander verbunden sind, sowie für die Zuweisung der korrekten Access-VLANs auf den Endgeräte-Ports.  

### Inter-VLAN Firewall-Regeln

Die eigentliche Isolation und Kontrolle zwischen den definierten VLAN-Zonen wird durch Firewall-Regeln auf den jeweiligen logischen VLAN-Schnittstellen in pfSense durchgesetzt. Hierbei ist das ZTA-Prinzip "Default Deny" und "Least Privilege" strikt anzuwenden:

1. **Grundsatz: Default Deny:** Auf jeder neu erstellten VLAN-Schnittstelle gibt es standardmäßig keine "Pass"-Regeln. Die implizite "Deny All"-Regel am Ende der Regelliste blockiert jeglichen Verkehr, der nicht explizit durch eine darüberliegende Regel erlaubt wird. Dieser Zustand muss beibehalten werden. Es dürfen keine pauschalen "Allow Any to Any"-Regeln zwischen VLANs erstellt werden.
2. **Explizite Freigaben (Least Privilege):** Nur absolut notwendige Kommunikationspfade zwischen den VLANs dürfen durch spezifische "Pass"-Regeln freigegeben werden. Diese Regeln müssen so granular wie möglich sein:
    - **Spezifische Quelle/Ziel:** Genaue IP-Adressen oder Subnetze angeben. Aliase verwenden, um die Verwaltung zu erleichtern (z.B. `Alias_IT_Admin_Subnet`, `Alias_SQL_Server_IP`).
    - **Spezifisches Protokoll/Port:** Nur die benötigten Protokolle (TCP, UDP, ICMP) und Ziel-Ports freigeben (z.B. TCP Port 22 für SSH, TCP Port 443 für HTTPS, UDP Port 53 für DNS). Vermeiden Sie "any" bei Protokoll und Port.  
        
    - **Regelplatzierung:** Regeln werden von oben nach unten abgearbeitet; die erste passende Regel gewinnt. Spezifischere Regeln sollten daher über allgemeineren Regeln stehen.  
        

**Beispielregeln (Annahme: Regeln werden auf der Quell-Interface-Seite erstellt):**

- **Regel auf Interface IT_ADMIN (VLAN 20):**
    - _Erlaube SSH zu Servern:_ Action=Pass, Interface=IT_ADMIN, Protocol=TCP, Source=IT_ADMIN net, Destination=SERVER net, Destination Port=22, Description="Allow IT SSH to Servers"
    - _Erlaube Zugriff auf pfSense GUI:_ Action=Pass, Interface=IT_ADMIN, Protocol=TCP, Source=IT_ADMIN net, Destination=<pfSense_IP_Alias>, Destination Port=<GUI_Port>, Description="Allow IT GUI Access"
- **Regel auf Interface CLIENTS_TRUSTED (VLAN 30):**
    - _Erlaube DNS zu internem DNS-Server (im SERVER VLAN):_ Action=Pass, Interface=CLIENTS_TRUSTED, Protocol=UDP, Source=CLIENTS_TRUSTED net, Destination=<Internal_DNS_Server_IP>, Destination Port=53, Description="Allow Client DNS"
    - _Erlaube Zugriff auf Drucker (im SERVER VLAN):_ Action=Pass, Interface=CLIENTS_TRUSTED, Protocol=TCP, Source=CLIENTS_TRUSTED net, Destination=<Printer_Alias>, Destination Port=<Printer_Ports_Alias>, Description="Allow Client Printing"
    - _Blockiere direkten Zugriff auf SERVER VLAN (außer explizit erlaubt):_ Action=Block, Interface=CLIENTS_TRUSTED, Protocol=Any, Source=CLIENTS_TRUSTED net, Destination=SERVER net, Description="Block Client to Server (Default)" (Diese Regel ist oft implizit durch Default Deny abgedeckt, kann aber zur Klarheit hinzugefügt werden).
- **Regel auf Interface IOT_DEVICES (VLAN 40):**
    - _Blockiere jeglichen Zugriff auf andere interne Netze:_ Action=Block, Interface=IOT_DEVICES, Protocol=Any, Source=IOT_DEVICES net, Destination=<RFC1918_Alias>, Description="Block IoT to Internal Networks" (Diese Regel sollte ganz oben stehen).
    - _Erlaube notwendigen Internetzugriff (Policy Routing):_ (Siehe Abschnitt IX)

3. **Nutzung von Aliases:** Die konsequente Verwendung von Aliases (**Firewall > Aliases**) für IP-Adressen, Netzwerke und Ports ist unerlässlich, um die Übersichtlichkeit und Wartbarkeit der Inter-VLAN-Regeln zu gewährleisten. Änderungen (z.B. Hinzufügen eines neuen Servers) erfordern dann nur die Anpassung des Alias, nicht mehrerer Regeln.  
    
4. **Logging aktivieren:** Für jede "Pass"-Regel zwischen VLANs sollte die Logging-Option (**Log packets that are handled by this rule**) aktiviert werden. Dies ermöglicht die Überwachung des erlaubten Verkehrs und die Verifizierung, dass nur die beabsichtigte Kommunikation stattfindet.  
    

Die Implementierung einer granularen Mikrosegmentierung führt unweigerlich zu einer größeren Anzahl von Firewall-Regeln im Vergleich zu traditionellen, flacheren Netzwerkdesigns. Dies unterstreicht die Notwendigkeit einer äußerst disziplinierten Vorgehensweise bei der Erstellung, Dokumentation und vor allem der regelmäßigen Überprüfung dieser Regeln. Jede Regel muss einen klaren Zweck haben und dem Prinzip der geringsten Rechte entsprechen. Veraltete oder unnötig permissive Regeln stellen ein Risiko dar und müssen proaktiv identifiziert und entfernt oder angepasst werden. Ohne sorgfältige Planung und kontinuierliche Pflege kann das Regelwerk schnell unübersichtlich und fehleranfällig werden, was die Vorteile der Mikrosegmentierung zunichtemachen würde.  

## V. Durchsetzung des Least Privilege Prinzips auf Netzwerkebene

Das Prinzip der geringsten Rechte (Least Privilege) ist ein Eckpfeiler der Zero Trust Architecture. Es besagt, dass Benutzer, Geräte und Anwendungen nur die minimal notwendigen Berechtigungen erhalten sollten, um ihre spezifischen Aufgaben auszuführen. In pfSense wird dies hauptsächlich durch die Konfiguration spezifischer Firewall-Regeln und die Absicherung der Firewall selbst erreicht.  

### Spezifische Firewall-Regeln

Wie bereits im Kontext der Mikrosegmentierung erwähnt, ist die Granularität der Firewall-Regeln entscheidend für die Umsetzung von Least Privilege. Folgende Praktiken sollten angewendet werden:

- **Vermeidung von "Any":** Wo immer möglich, sollte die Verwendung von "any" in den Feldern für Protokoll, Quell-/Ziel-IP und Quell-/Ziel-Port vermieden werden.  
    
- **Protokollspezifität:** Statt "any" oder "TCP/UDP" sollten spezifische Protokolle (TCP, UDP, ICMP usw.) ausgewählt werden. Bei ICMP sollte idealerweise auch der spezifische ICMP-Typ (z.B. "Echo Request" für Ping) angegeben werden, anstatt pauschal "any" ICMP zu erlauben.  
    
- **Quell-/Zielspezifität:** Definieren Sie exakte Quell- und Ziel-IP-Adressen, Subnetze oder gut gepflegte Aliase. Die Verwendung von Interface-Netzwerken (z.B. "LAN net") ist oft notwendig, aber spezifischere Regeln für bekannte Kommunikationspfade (z.B. zwischen zwei bestimmten Servern) sind vorzuziehen.  
    
- **Portspezifität:** Geben Sie immer die spezifischen Ziel-Ports an, die für den Dienst erforderlich sind (z.B. 443 für HTTPS, 3389 für RDP). Verwenden Sie Port-Aliase für Dienste, die mehrere Ports nutzen (z.B. `ActiveDirectory_Ports`). Quell-Ports werden in der Regel auf "any" belassen, da diese oft dynamisch vom Client gewählt werden.  
    
- **Regelreihenfolge:** Platzieren Sie die spezifischsten Regeln (z.B. Blockieren eines bestimmten Hosts) über allgemeineren Regeln (z.B. Erlauben des Subnetzes).  
    
- **Standardaktion:** Stellen Sie sicher, dass die Standardaktion (implizit oder explizit am Ende der Regelliste) "Block" oder "Reject" ist, um das "Default Deny"-Prinzip umzusetzen.  
    

### Absicherung des pfSense Management-Zugriffs

Die pfSense-Firewall selbst ist die zentrale Durchsetzungsinstanz für die Zero Trust-Richtlinien und stellt somit ein hochprivilegiertes Ziel dar. Ihre Absicherung ist von größter Bedeutung und muss denselben strengen ZTA-Prinzipien folgen.

- **HTTPS erzwingen:** Der Zugriff auf die Web-GUI muss zwingend über HTTPS erfolgen. Konfigurieren Sie dies unter **System > Advanced > Admin Access > Protocol = HTTPS (SSL/TLS)**. Es wird dringend empfohlen, ein Zertifikat von einer vertrauenswürdigen Zertifizierungsstelle (CA) zu verwenden, entweder kommerziell erworben oder kostenlos über das ACME-Paket (Let's Encrypt) bezogen und installiert. Dies vermeidet Browser-Warnungen und erhöht das Vertrauen.  
    
- **Starke Passwörter:** Alle Benutzerkonten, die auf die GUI oder SSH zugreifen können (**System > User Manager**), müssen über starke, einzigartige Passwörter verfügen. Die Verwendung eines Passwort-Managers wird empfohlen.
- **Zugriffsbeschränkung auf die GUI/SSH:**
    - **Netzwerksegment:** Idealerweise sollte der Management-Zugriff nur aus einem dedizierten, stark gesicherten Management-VLAN erlaubt sein.
    - **IP-Adressen:** Beschränken Sie den Zugriff auf bestimmte, vertrauenswürdige IP-Adressen oder Subnetze. Dies geschieht durch Firewall-Regeln auf der/den Management-Schnittstelle(n).
    - **Anti-Lockout Rule:** Die standardmäßig aktive "Anti-Lockout Rule" (**System > Advanced > Admin Access > webConfigurator anti-lockout**) erlaubt den Zugriff auf die GUI von jeder IP-Adresse im LAN-Subnetz. Für eine ZTA-konforme Konfiguration sollte diese Regel deaktiviert werden. **WICHTIG:** Deaktivieren Sie die Anti-Lockout-Regel _erst_, nachdem Sie eine explizite Firewall-Regel auf der Management-Schnittstelle erstellt haben, die den Zugriff von Ihren autorisierten Management-IPs auf den GUI-Port (TCP, Standard 443 oder benutzerdefiniert) erlaubt. Andernfalls sperren Sie sich selbst aus. Die Regel sollte lauten: Action=Pass, Protocol=TCP, Source=<Management_IPs_Alias>, Destination=<Management_Interface_Address>, Destination Port=<GUI_Port_Alias>. Direkt darunter sollte eine Regel stehen, die jeglichen anderen Zugriff auf diesen Port blockiert.  
        
- **Multi-Faktor-Authentifizierung (MFA):** pfSense bietet keine native MFA für den GUI-Login. Es ist jedoch möglich, die Authentifizierung an einen externen RADIUS-Server zu delegieren (**System > User Manager > Settings > Authentication Server**), der seinerseits MFA erzwingt. Wenn beispielsweise FreeRADIUS auf pfSense oder einem anderen Server für MFA konfiguriert ist, kann dieser als Authentifizierungs-Backend für GUI-Benutzer ausgewählt werden.  
    
- **SSH-Zugriff:**
    - **Deaktivieren:** Wenn der SSH-Zugriff nicht regelmäßig benötigt wird, sollte er unter **System > Advanced > Admin Access > Secure Shell Server** deaktiviert werden.  
        
    - **Sichern:** Wenn SSH benötigt wird:
        - Bevorzugen Sie die schlüsselbasierte Authentifizierung und deaktivieren Sie die Passwort-Authentifizierung.
        - Beschränken Sie den Zugriff über Firewall-Regeln auf der entsprechenden Schnittstelle auf autorisierte Quell-IP-Adressen (analog zur GUI-Zugriffsbeschränkung).
        - Ändern Sie den Standard-SSH-Port (TCP 22), um automatisierte Scans zu erschweren (dies ist jedoch Security by Obscurity und kein Ersatz für starke Authentifizierung und Zugriffskontrolle).

Die konsequente Anwendung von Least Privilege auf die Firewall selbst ist unerlässlich. Jede unnötige Freigabe oder Schwachstelle im Management-Zugriff kann die gesamte ZTA-Strategie untergraben, da ein Angreifer, der die Kontrolle über die Firewall erlangt, die Sicherheitsrichtlinien manipulieren könnte.

## VI. Implementierung stärkerer Authentifizierung und Autorisierung

Ein zentrales Element der Zero Trust Architecture ist die Abkehr von implizitem Vertrauen basierend auf dem Netzwerkstandort und die Hinwendung zu starker, expliziter Authentifizierung und Autorisierung für jeden Zugriffsversuch. pfSense bietet mehrere Mechanismen, um dies umzusetzen, oft in Verbindung mit externen Identitätsmanagementsystemen.  

### Captive Portal mit RADIUS/LDAP

Das Captive Portal in pfSense (**Services > Captive Portal**) eignet sich hervorragend, um den Netzwerkzugang in bestimmten Segmenten (z.B. Gäste-WLAN, BYOD-Netzwerk, IoT-Onboarding-Netzwerk) zu kontrollieren und eine Benutzer- oder Geräteauthentifizierung zu erzwingen, bevor weiterer Netzwerk- oder Internetzugriff gewährt wird.  

- **Konfiguration:** Eine Captive Portal Zone wird erstellt und einer oder mehreren Schnittstellen zugewiesen.  
    
- **Authentifizierungsmethoden:**
    - **Keine Authentifizierung / Klick:** Einfachste Form, erfordert nur das Akzeptieren von Nutzungsbedingungen. Bietet keine echte Authentifizierung im ZTA-Sinne.
    - **Lokale Benutzerdatenbank:** Benutzer werden direkt in pfSense (**System > User Manager > Users**) verwaltet. Geeignet für kleinere Umgebungen.
    - **Voucher:** Zeitlich begrenzte Zugangscodes. Nützlich für Gäste.
    - **RADIUS / LDAP:** Die für ZTA relevantesten Methoden. Hierbei wird die Authentifizierung an einen zentralen RADIUS- oder LDAP-Server (z.B. Active Directory, FreeRADIUS, OpenLDAP) delegiert.  
        
- **RADIUS/LDAP Integration:**
    1. Konfigurieren Sie den externen Authentifizierungsserver unter **System > User Manager > Authentication Servers**. Stellen Sie sicher, dass die Kommunikation sicher ist (LDAPS/STARTTLS für LDAP, sicheres RADIUS-Setup).  
        
    2. Wählen Sie in der Captive Portal Zonenkonfiguration unter **Authentication Method** die Option "Use an Authentication backend".  
        
    3. Wählen Sie den/die konfigurierten RADIUS- oder LDAP-Server im Feld **Authentication Server** aus.  
        
    4. Konfigurieren Sie bei Bedarf zusätzliche RADIUS-Optionen wie Accounting, MAC-Authentifizierung oder Reauthentifizierungsintervalle.  
        

### VPN-Authentifizierung (Beispiel OpenVPN)

VPNs sind entscheidend für den sichuren Fernzugriff, müssen aber im ZTA-Kontext ebenfalls stark authentifiziert werden. OpenVPN auf pfSense bietet hier flexible Möglichkeiten.  

- **Zertifikatsbasierte Authentifizierung:** Dies ist eine sehr sichere Methode, bei der sowohl der Server als auch der Client ihre Identität durch digitale Zertifikate nachweisen.
    1. Erstellen Sie eine Certificate Authority (CA) unter **System > Cert. Manager > CAs**.  
        
    2. Erstellen Sie ein Serverzertifikat (**System > Cert. Manager > Certificates**) für den OpenVPN-Server, signiert von Ihrer CA.
    3. Erstellen Sie für jeden VPN-Benutzer ein eigenes Client-Zertifikat, ebenfalls signiert von Ihrer CA.
    4. Konfigurieren Sie den OpenVPN-Server (**VPN > OpenVPN > Servers > Edit**) für "Remote Access (SSL/TLS)" oder "Remote Access (SSL/TLS + User Auth)" und wählen Sie die erstellte CA und das Serverzertifikat aus.  
        
    5. Verteilen Sie die CA-, Client-Zertifikat- und Schlüsseldateien sicher an die Benutzer, typischerweise über das OpenVPN Client Export Package.  
        
- **Multi-Faktor-Authentifizierung (MFA) via RADIUS:** Um die Sicherheit weiter zu erhöhen, kann die zertifikatsbasierte Authentifizierung mit einer Benutzerauthentifizierung inklusive MFA kombiniert werden.
    1. Konfigurieren Sie den OpenVPN-Server für "Remote Access (SSL/TLS + User Auth)".  
        
    2. Wählen Sie als **Backend for Authentication** einen konfigurierten RADIUS-Server aus.  
        
    3. Konfigurieren Sie den RADIUS-Server (z.B. das FreeRADIUS-Paket auf pfSense) so, dass er eine zweite Authentifizierungsmethode (z.B. OTP via Google Authenticator, SMS, Push) nach der initialen Passwort- oder Zertifikatsprüfung (falls RADIUS dies unterstützt) anfordert.  
        
    4. Im Falle von FreeRADIUS auf pfSense mit Google Authenticator: Richten Sie Benutzer im FreeRADIUS-Paket ein, generieren Sie OTP-Secrets und weisen Sie PINs zu.  
        
    5. Der Benutzer authentifiziert sich am VPN-Client mit seinem Benutzernamen und einem Passwort, das sich aus PIN + aktuellem OTP-Code zusammensetzt. Das Client-Zertifikat wird ebenfalls zur Authentifizierung verwendet.  
        

Während IPsec ebenfalls Zertifikate und Benutzerauthentifizierung (z.B. via RADIUS) unterstützt, gilt OpenVPN oft als flexibler und Firewall-freundlicher. WireGuard bietet derzeit keine native Benutzerauthentifizierung und verlässt sich auf den sicheren Austausch kryptographischer Schlüssel.  

### Port-basierte Zugriffskontrolle (IEEE 802.1X)

802.1X bietet eine robuste Methode zur Authentifizierung von Geräten direkt am Netzwerkzugangspunkt (Switch-Port oder WLAN Access Point), bevor diesen überhaupt Zugriff auf ein VLAN gewährt wird. Dies ist ein starker Mechanismus zur Durchsetzung von ZTA am Netzwerkrand.

- **Funktionsweise:** Ein Gerät (Supplicant) versucht, sich mit dem Netzwerk zu verbinden. Der Switch oder Access Point (Authenticator) fordert Authentifizierungsdaten an und leitet diese an einen RADIUS-Server (Authentication Server) weiter. Der RADIUS-Server überprüft die Anmeldeinformationen (z.B. Benutzername/Passwort, Zertifikat, MAC-Adresse) und teilt dem Authenticator mit, ob der Zugriff gewährt werden soll und optional, welchem VLAN das Gerät zugewiesen werden soll.  
    
- **Rolle von pfSense:** pfSense kann hierbei als RADIUS-Server fungieren, indem das FreeRADIUS-Paket installiert und konfiguriert wird. Alternativ kann pfSense auch Benutzer/Geräte gegen einen externen RADIUS-Server authentifizieren, wenn z.B. VPN- oder Captive-Portal-Logins erfolgen.  
    
- **Konfiguration (mit FreeRADIUS auf pfSense):**
    1. Installieren Sie das FreeRADIUS-Paket (**System > Package Manager**).
    2. Konfigurieren Sie unter **Services > FreeRADIUS**:
        - **NAS / Clients:** Fügen Sie Ihre 802.1X-fähigen Switches und/oder Access Points als RADIUS-Clients mit deren IP-Adressen und einem Shared Secret hinzu.  
            
        - **Interfaces:** Definieren Sie, auf welchen pfSense-IP-Adressen und Ports (Standard: 1812 für Authentifizierung, 1813 für Accounting) der RADIUS-Server lauschen soll.  
            
        - **Users:** Definieren Sie Benutzerkonten oder konfigurieren Sie die Authentifizierung gegen eine andere Quelle (z.B. LDAP, wenn FreeRADIUS entsprechend konfiguriert ist).
        - **EAP:** Konfigurieren Sie die gewünschten Extensible Authentication Protocol (EAP)-Typen. Für hohe Sicherheit ist EAP-TLS (zertifikatsbasiert) zu empfehlen. Dies erfordert die Verwaltung von Server- und Client-Zertifikaten. Andere Optionen wie PEAP oder EAP-TTLS können Benutzername/Passwort-Authentifizierung über einen verschlüsselten Tunnel ermöglichen.  
            
        - **(Optional) Dynamische VLAN-Zuweisung:** Konfigurieren Sie RADIUS-Antwortattribute (Reply-Items) für Benutzer oder Gruppen, um dem Switch/AP mitzuteilen, in welches VLAN das Gerät platziert werden soll (z.B. `Tunnel-Type = VLAN`, `Tunnel-Medium-Type = IEEE-802`, `Tunnel-Private-Group-Id = <VLAN-ID>`).  
            
- **Anforderungen:**
    - 802.1X-fähige Netzwerk-Hardware (Managed Switches, Enterprise Access Points).  
        
    - Konfiguration der Switches/APs für 802.1X-Authentifizierung (Angabe des RADIUS-Servers, Aktivierung auf Ports/SSIDs).
    - Konfiguration der Client-Geräte (Supplicant-Einstellungen, ggf. Installation von Zertifikaten).

Die Implementierung von 802.1X stellt einen signifikanten Schritt in Richtung ZTA dar, erfordert jedoch eine sorgfältige Planung und Konfiguration aller beteiligten Komponenten.

Ein wichtiger Aspekt der ZTA ist die Dynamik der Authentifizierung und Autorisierung. Während pfSense Mechanismen wie Captive Portal Timeouts oder RADIUS Reauthentication Intervalle bietet, die eine _periodische_ Neuprüfung ermöglichen, fehlt oft die Fähigkeit zur _kontinuierlichen_ Neubewertung basierend auf sich änderndem Kontext (z.B. erkanntes Risiko, geänderter Standort). Eine solche echte dynamische Anpassung erfordert in der Regel die Integration mit fortschrittlicheren Identity and Access Management (IAM) oder Security Orchestration, Automation, and Response (SOAR) Systemen, die über die von pfSense bereitgestellten Schnittstellen (wie RADIUS oder LDAP mit erweiterten Attributen) interagieren können.  

## VII. Kontinuierliche Überprüfung mittels IDS/IPS

Die kontinuierliche Überprüfung des Netzwerkverkehrs ist ein weiteres fundamentales Prinzip der Zero Trust Architecture. Intrusion Detection Systems (IDS) und Intrusion Prevention Systems (IPS) spielen hierbei eine entscheidende Rolle, indem sie den Datenstrom auf bekannte Bedrohungsmuster, Anomalien und potenzielle Richtlinienverstöße analysieren. Im ZTA-Kontext ist es besonders wichtig, diese Überwachung nicht nur am Netzwerkperimeter (Nord-Süd-Verkehr), sondern auch _innerhalb_ des Netzwerks zwischen den Mikrosegmenten (Ost-West-Verkehr) durchzuführen.  

### Rolle von IDS/IPS in ZTA

In einem ZTA-Modell wird davon ausgegangen, dass Bedrohungen jederzeit und überall im Netzwerk auftreten können ("Assume Breach"). IDS/IPS dienen als wichtige Sensoren, um:  

- **Bekannte Angriffe zu erkennen:** Durch den Abgleich des Traffics mit Signaturdatenbanken (Regelwerken) können bekannte Malware, Exploits oder Angriffstechniken identifiziert werden.
- **Anomalien aufzudecken:** Abweichungen vom normalen Netzwerkverhalten können auf unbekannte Bedrohungen oder kompromittierte Systeme hindeuten.
- **Richtlinienverstöße zu identifizieren:** IDS/IPS können so konfiguriert werden, dass sie die Nutzung unerwünschter Protokolle oder den Zugriff auf gesperrte Ressourcen erkennen.
- **Laterale Bewegungen zu blockieren (im IPS-Modus):** Wenn ein Angreifer versucht, sich von einem kompromittierten System innerhalb eines Segments auf andere Segmente auszubreiten, kann ein IPS dies erkennen und aktiv verhindern.

### Snort vs. Suricata auf pfSense

pfSense bietet zwei leistungsstarke Open-Source-IDS/IPS-Lösungen als installierbare Pakete an: Snort und Suricata.

- **Snort:** Das ältere, sehr etablierte System mit einer großen Community und umfangreichen Regelwerken. Traditionell single-threaded, was auf moderner Multi-Core-Hardware ein Performance-Limit darstellen kann.  
    
- **Suricata:** Eine modernere Alternative, die von Grund auf für Multi-Core-Architekturen entwickelt wurde und daher oft eine bessere Performance bietet. Suricata verfügt zudem über erweiterte Fähigkeiten zur Protokollerkennung (Application Layer Detection), was die Genauigkeit verbessern und False Positives reduzieren kann.  
    

Beide Systeme können über **System > Package Manager** installiert und anschließend unter **Services > Snort** bzw. **Services > Suricata** konfiguriert werden. Für moderne Hardware und im Sinne besserer Performance und Erkennungsgenauigkeit wird oft Suricata empfohlen.  

### Konfiguration für Ost-West-Traffic

Um die für ZTA erforderliche Sichtbarkeit innerhalb des Netzwerks zu erreichen, ist es unerlässlich, IDS/IPS-Instanzen auf den internen Schnittstellen (VLAN-Interfaces) zu konfigurieren:

1. **Instanz pro Interface:** Für jede relevante interne Schnittstelle (z.B. SERVER VLAN, CLIENTS_TRUSTED VLAN, IT_ADMIN VLAN), deren ein- und ausgehender Verkehr überwacht werden soll, muss eine eigene Snort/Suricata-Instanz unter **Services > Snort/Suricata > Snort/Suricata Interfaces > Add** hinzugefügt werden. Wählen Sie das entsprechende VLAN-Interface aus der Liste aus.  
    
2. **Regelwerke aktivieren:** Für jede Interface-Instanz müssen die gewünschten Regelwerke aktiviert werden. Navigieren Sie zu **Services > Snort/Suricata > [Interface Name] > Categories**. Hier können Sie entweder vordefinierte IPS Policies (falls Snort VRT Rules aktiviert sind) auswählen oder manuell Regelkategorien von Anbietern wie Emerging Threats (ET Open/Pro) oder Snort (VRT/Community) aktivieren. Beginnen Sie mit einem ausgewogenen Set (z.B. ET Open) und erweitern Sie es bei Bedarf.  
    
3. **Betriebsmodus (IDS vs. IPS):**
    - **IDS (Detection Mode):** Das System protokolliert nur erkannte Bedrohungen, blockiert aber keinen Verkehr. Dies ist der empfohlene Startmodus, um die Auswirkungen auf das Netzwerk zu verstehen und False Positives (fälschlicherweise als bösartig erkannter legitimer Verkehr) zu identifizieren. In den Interface-Einstellungen (**Services > Snort/Suricata > [Interface Name] > Settings**) ist die Option **Block Offenders** _deaktiviert_.  
        
    - **IPS (Prevention Mode):** Das System blockiert aktiv den als bösartig erkannten Verkehr. Dies bietet einen höheren Schutz, birgt aber das Risiko, legitimen Verkehr bei False Positives zu blockieren. Aktivieren Sie diesen Modus erst nach sorgfältigem Tuning im IDS-Modus, indem Sie **Block Offenders** _aktivieren_.  
        

Die Überwachung des Ost-West-Traffics ist ein kritischer Unterschied zur traditionellen IDS/IPS-Platzierung nur am WAN-Perimeter. Sie ermöglicht die Erkennung von Bedrohungen, die bereits interne Systeme kompromittiert haben und versuchen, sich seitlich im Netzwerk auszubreiten oder auf andere interne Ressourcen zuzugreifen. Dies ist für das "Assume Breach"-Prinzip der ZTA von zentraler Bedeutung.  

### Regelwerk-Management und Best Practices

Ein effektiver IDS/IPS-Einsatz erfordert kontinuierliche Pflege und Optimierung:

- **Regelmäßige Updates:** Halten Sie die Regelwerke stets aktuell. Konfigurieren Sie automatische Updates unter **Services > Snort/Suricata > Global Settings > Update Interval** (z.B. alle 12 Stunden) und überprüfen Sie den Status unter **Updates**. Bezahlte Regelwerke (ET Pro, Snort Subscriber) bieten oft schnellere Updates für neue Bedrohungen.  
    
- **Regelauswahl:** Aktivieren Sie nur die Regelkategorien, die für Ihre Umgebung relevant sind. Zu viele aktive Regeln erhöhen die Systemlast und die Wahrscheinlichkeit von False Positives. Vordefinierte IPS Policies (Connectivity, Balanced, Security bei Snort VRT) können als Ausgangspunkt dienen.  
    
- **Pass Lists:** Definieren Sie unter **Services > Snort/Suricata > Pass Lists** IP-Adressen oder Netzwerke, die niemals blockiert werden sollen (z.B. Management-Server, Vulnerability Scanner, DNS-Server, die pfSense-Firewall selbst). Weisen Sie die relevante Pass List der jeweiligen Interface-Instanz unter deren Einstellungen zu. Die Standard-Passlist, die Firewall-IPs enthält, sollte unbedingt beibehalten werden.  
    
- **Alert Analyse und Tuning (Suppression):** Überwachen Sie die generierten Alerts unter **Services > Snort/Suricata > Alerts**. Analysieren Sie wiederkehrende Alerts, die legitimen Verkehr betreffen (False Positives). Erstellen Sie Suppress-Regeln (**Services > Snort/Suricata > Suppress > Add** oder direkt aus der Alert-Ansicht), um diese spezifischen Alerts für bestimmte Quell-/Ziel-IPs oder ganze Regeln zu unterdrücken. Dies ist ein iterativer Prozess, um das "Rauschen" zu reduzieren und die Relevanz der verbleibenden Alerts zu erhöhen.  
    
- **Benutzerdefinierte Regeln:** Erwägen Sie die Erstellung eigener Regeln (**Services > Snort/Suricata > Custom Rules**) für spezifische interne Sicherheitsrichtlinien, die von Standardregelwerken möglicherweise nicht abgedeckt werden (z.B. Erkennung der Nutzung veralteter Protokolle zwischen bestimmten Segmenten).  
    

Der Betrieb von IDS/IPS, insbesondere auf mehreren internen Interfaces und potenziell im IPS-Modus, stellt hohe Anforderungen an die CPU- und RAM-Ressourcen der pfSense-Hardware. Eine unzureichende Dimensionierung kann zu Performance-Engpässen und Paketverlusten führen. Suricatas Fähigkeit zur Nutzung mehrerer CPU-Kerne ist hier vorteilhaft. Dennoch ist eine sorgfältige Auswahl und das kontinuierliche Tuning der aktiven Regeln unerlässlich, um sowohl die Erkennungsleistung als auch die Systemperformance zu optimieren.  

## VIII. Gewährleistung der Transparenz durch Logging und Monitoring

Umfassende Sichtbarkeit ist eine Grundvoraussetzung für Zero Trust. Ohne detaillierte Protokollierung und effektives Monitoring ist es unmöglich, Zugriffsversuche zu verifizieren, den Sicherheitszustand von Ressourcen zu bewerten und auf Vorfälle angemessen zu reagieren. pfSense bietet umfangreiche Logging-Funktionen, die als Basis für die in ZTA geforderte Transparenz dienen.  

### Essentielle Logs für ZTA

Für eine effektive ZTA-Implementierung sollten mindestens die folgenden Log-Quellen in pfSense aktiv überwacht und idealerweise zentralisiert werden:

- **Firewall Logs:** Dies ist eine der wichtigsten Log-Quellen. Sie enthält Informationen über jede Verbindung, die von den Firewall-Regeln verarbeitet wird (erlaubt oder blockiert).
    - Zugriff: **Status > System Logs > Firewall > Normal View / Raw View**.
    - Konfiguration: Logging muss pro Regel aktiviert werden (**Firewall > Rules > Edit Rule > Log** Checkbox). Es ist entscheidend, Logging für alle relevanten "Pass"-Regeln (insbesondere zwischen VLANs) und wichtigen "Block"-Regeln zu aktivieren. Zusätzlich sollte das Logging für Pakete, die von den Standard-Blockregeln erfasst werden, unter **Status > System Logs > Settings > Log firewall default blocks** aktiviert werden.  
        
- **IDS/IPS Logs (Snort/Suricata):** Protokolle über erkannte Bedrohungen (Alerts) und im IPS-Modus blockierte Hosts.
    - Zugriff: **Services > Snort/Suricata > Alerts** bzw. **Blocked**.
    - Konfiguration: Alerts sollten zur zentralen Erfassung auch an das System-Log gesendet werden (**Services > Snort/Suricata > [Interface] > Settings > Send Alerts to System Log**).  
        
- **Authentifizierungs-Logs:**
    - **GUI/System Logins:** Werden im Haupt-Systemlog erfasst (**Status > System Logs > System**).
    - **Captive Portal:** Login-Versuche, Erfolge, Fehler (**Status > System Logs > Captive Portal**).
    - **VPN (OpenVPN/IPsec):** Verbindungsaufbau, Authentifizierungsereignisse, Fehler (**Status > System Logs > OpenVPN / IPsec**).
    - **RADIUS/LDAP:** Authentisierungsversuche über diese Backends werden oft im Haupt-Systemlog protokolliert, insbesondere wenn Debugging aktiviert ist.  
        
- **DNS Resolver/Forwarder Logs:** Aufschluss über DNS-Anfragen von Clients. Kann helfen, Malware-Kommunikation (C&C-Server) oder Datenexfiltration über DNS zu erkennen.
    - Zugriff: **Status > System Logs > DNS Resolver / DNS Forwarder**.
    - Konfiguration: Muss explizit aktiviert werden unter **Services > DNS Resolver / DNS Forwarder > Logging**.
- **DHCP Logs:** Zeigt, welche IP-Adresse welchem Gerät (MAC-Adresse) zugewiesen wurde. Wichtig für die Zuordnung von Netzwerkaktivitäten zu Geräten.
    - Zugriff: **Status > System Logs > DHCP**.
- **Gateway Logs:** Protokolliert Statusänderungen der WAN-Gateways (Online, Offline, Latenz-/Verlustwarnungen). Relevant für die Analyse von Multi-WAN-Failover-Ereignissen.
    - Zugriff: **Status > System Logs > Gateways**.  
        
- **System Logs:** Allgemeine Systemereignisse, Start/Stopp von Diensten, Hardware-Ereignisse, Konfigurationsänderungen durch Administratoren.
    - Zugriff: **Status > System Logs > System**.
- **(Optional) HAProxy Logs:** Wenn HAProxy als Reverse Proxy genutzt wird, können dessen Zugriffslogs wertvolle Informationen über Anfragen an interne Dienste liefern. Die Protokollierung muss in den HAProxy-Einstellungen konfiguriert werden.  
    

### Log-Konfiguration in pfSense

Unter **Status > System Logs > Settings** können grundlegende Logging-Parameter angepasst werden:

- **Log Rotation Size:** Definiert die maximale Größe der einzelnen Log-Dateien auf der Firewall, bevor sie rotiert werden. Da der lokale Speicherplatz (insbesondere auf Embedded-Geräten) begrenzt ist, ist dies ein wichtiger Parameter, der aber auch bedeutet, dass ältere Logs lokal verloren gehen.  
    
- **Log Message Format:** Hier kann das Format der Log-Nachrichten eingestellt werden. Für die Weiterleitung an SIEM-Systeme wird das standardisierte `syslog (RFC 5424, with RFC 3339 microsecond-precision timestamps)` Format empfohlen, da es strukturierter ist als das ältere BSD-Format (RFC 3164).  
    

### Log-Zentralisierung (Remote Syslog)

Da die lokale Speicherung von Logs auf der pfSense-Firewall begrenzt ist und eine zentrale Analyse für ZTA unerlässlich ist, müssen die relevanten Logs an einen externen Syslog-Server oder ein SIEM-System gesendet werden.

- **Konfiguration:** Erfolgt unter **Status > System Logs > Settings > Remote Logging Options**.
    
    - **Enable Remote Logging:** Aktiviert die Weiterleitung.
    - **Remote Log Servers:** Hier werden die IP-Adresse oder der Hostname und optional der Port (Standard UDP 514) des Zielservers eingetragen. Bis zu drei Server können angegeben werden.  
        
    - **Remote Syslog Contents:** Hier wird ausgewählt, welche Log-Typen (Everything, Firewall Events, System Events, DNS Events etc.) an den Remote-Server gesendet werden sollen. Es sollten alle unter "Essentielle Logs für ZTA" genannten Typen ausgewählt werden.  
        
    - **Source Address / IP Protocol:** Steuert, von welcher IP-Adresse der Firewall die Logs gesendet werden. Normalerweise ist "Any" ausreichend.  
        
    
     
    
- **Sicherheit:** Das Standard-Syslog-Protokoll über UDP ist unverschlüsselt. Log-Daten können sensible Informationen enthalten. Daher sollte die Übertragung zum Syslog-Server entweder über einen sicheren Kanal (z.B. VPN-Tunnel) erfolgen oder das **syslog-ng** Paket installiert werden, welches verschlüsselte Übertragung über TCP/TLS unterstützt.  
    

### Analyse und Monitoring

Die gesammelten und zentralisierten Logs müssen analysiert werden, um die für ZTA notwendige kontinuierliche Überprüfung zu ermöglichen:

- **pfSense Dashboard:** Bietet Widgets für einen schnellen Überblick über Systemstatus, Gateway-Status, Firewall-Logs, Snort/Suricata-Alerts etc.. Nützlich für Echtzeit-Monitoring, aber nicht für tiefgehende Analysen oder Langzeitspeicherung.  
    
- **Manuelle Log-Prüfung:** Regelmäßige Sichtung der Logs in pfSense oder auf dem zentralen Server kann Anomalien aufdecken, ist aber zeitaufwendig und skaliert schlecht.
- **SIEM-Systeme:** Der Einsatz eines SIEM ist die effektivste Methode. SIEMs können Logs aus verschiedensten Quellen (pfSense, Server, Clients, Anwendungen) korrelieren, Langzeitspeicherung ermöglichen, komplexe Suchanfragen und Analysen durchführen und automatische Alarme bei verdächtigen Mustern oder Richtlinienverstößen auslösen. Beispiele für Systeme, die pfSense-Logs verarbeiten können, sind Google Security Operations , Rapid7 InsightIDR oder ManageEngine Firewall Analyzer.  
    

Die folgende Tabelle gibt eine Empfehlung für die Logging-Konfiguration im ZTA-Kontext:

**Tabelle 2: Empfohlene Logging-Konfiguration für ZTA in pfSense**

|Log-Quelle|Aktiviert|Logging-Level|An Remote Syslog senden|Begründung für ZTA-Relevanz|
|:--|:--|:--|:--|:--|
|Firewall|Ja|Normal|Ja|Kernkomponente: Erlaubte/Blockierte Verbindungen, Verifizierung von Regeln.|
|IDS/IPS (Snort/Suricata)|Ja|Normal/Alert|Ja|Erkennung von Bedrohungen und Anomalien (Kontinuierliche Überprüfung).|
|System|Ja|Normal|Ja|Administrative Aktivitäten, Systemzustand, Konfigurationsänderungen.|
|Authentifizierung|Ja|Normal|Ja|Nachverfolgung von Logins/Fehlern (GUI, VPN, Captive Portal, RADIUS/LDAP).|
|DNS Resolver/Fwd.|Ja|Normal/Detail|Ja|Sichtbarkeit von DNS-Anfragen (Erkennung von C&C, Exfiltration).|
|DHCP|Ja|Normal|Ja|Zuordnung von IP zu Gerät (MAC) für die Analyse von Netzwerkaktivitäten.|
|Gateways|Ja|Normal|Ja|Überwachung der WAN-Verfügbarkeit, Analyse von Failover-Ereignissen.|
|VPN (OpenVPN/IPsec)|Ja|Normal|Ja|Überwachung von VPN-Verbindungsaufbau, Authentifizierung und Fehlern.|

In Google Sheets exportieren

Ohne eine umfassende und zentralisierte Protokollierung ist das ZTA-Prinzip "Always Verify" in der Praxis kaum umsetzbar. Die Logs liefern die notwendigen Daten, um Zugriffsversuche zu validieren, Anomalien zu erkennen und auf Sicherheitsvorfälle effektiv reagieren zu können. Die sorgfältige Konfiguration des Loggings und die Weiterleitung an ein leistungsfähiges SIEM-System sind daher keine optionalen Ergänzungen, sondern fundamentale Bausteine einer jeden ernsthaften ZTA-Implementierung mit pfSense.  

## IX. Integration von Zero Trust in die Multi-WAN-Failover-Strategie

Die Implementierung von Zero Trust in einer Umgebung mit mehreren WAN-Verbindungen und Failover-Mechanismen bringt spezifische Komplexitäten mit sich. Die größte Herausforderung besteht darin, die konsistente Durchsetzung der granularen ZTA-Sicherheitsrichtlinien zu gewährleisten, unabhängig davon, welcher WAN-Pfad gerade aktiv ist. Dies betrifft insbesondere die Inter-VLAN-Kommunikation, Least-Privilege-Regeln und das Verhalten der Verbindungszustände (State Table) während eines Failovers.  

### Herausforderung: Konsistente Richtliniendurchsetzung

In einem Multi-WAN-Szenario kann sich der ausgehende Pfad für den Internetverkehr dynamisch ändern (Failover). ZTA verlangt jedoch, dass Sicherheitskontrollen wie Mikrosegmentierung, Least Privilege und IDS/IPS-Überwachung unabhängig vom aktiven Gateway konsistent angewendet werden. Fehlkonfigurationen können dazu führen, dass bei einem Failover Sicherheitsrichtlinien umgangen werden oder die interne Netzwerkkommunikation gestört wird.

### Policy Routing und Gateway Groups

pfSense nutzt Gateway Groups und Policy Routing, um den Datenverkehr über spezifische WAN-Verbindungen zu leiten oder Failover-Verhalten zu definieren:

- **Gateway Groups:** Unter **System > Routing > Gateway Groups** werden Gruppen von Gateways definiert. Für Failover werden die Gateways auf verschiedene Tiers verteilt (z.B. Tier 1 für primär, Tier 2 für sekundär). pfSense bevorzugt Gateways auf niedrigeren Tiers und wechselt auf höhere Tiers, wenn die bevorzugten Gateways ausfallen.  
    
- **Policy Routing:** Firewall-Regeln (**Firewall > Rules**) können über die erweiterten Optionen (`Display Advanced`) ein spezifisches Gateway oder eine Gateway Group zugewiesen bekommen. Verkehr, der auf eine solche Regel passt, wird über das zugewiesene Gateway/die Gruppe geleitet, anstatt dem Standard-Routing zu folgen.  
    

### Problem: Policy Routing vs. Lokaler Traffic (Inter-VLAN)

Ein häufiges Problem entsteht, wenn eine allgemeine "Pass"-Regel (z.B. "Allow LAN net to Any") auf einem internen Interface (wie LAN oder einem VLAN-Interface) eine Failover-Gateway-Group zugewiesen bekommt. In diesem Fall wird _jeglicher_ von dieser Regel erfasste Verkehr – auch Verkehr, der für andere interne VLANs oder lokale Server bestimmt ist – versucht, über die WAN-Gateways der Gruppe zu routen. Dies unterbricht die interne Kommunikation und widerspricht den Zielen der Mikrosegmentierung.  

**Lösung: Bypassing Policy Routing:**

Um sicherzustellen, dass nur der für das Internet bestimmte Verkehr über die Failover-Gruppe geleitet wird und lokaler Verkehr weiterhin der normalen Routing-Tabelle folgt, müssen Bypass-Regeln erstellt werden:

1. **Erstellen Sie einen Alias** (z.B. `Local_Networks`) unter **Firewall > Aliases > IP**, der alle Ihre internen und privaten Netzwerkbereiche umfasst (z.B. `192.168.0.0/16`, `172.16.0.0/12`, `10.0.0.0/8` sowie alle Ihre spezifischen VLAN-Subnetze und VPN-Tunnel-Netzwerke).  
    
2. **Erstellen Sie auf jedem internen Interface (LAN, VLANs)** eine Firewall-Regel **ganz oben** in der Regelliste:
    - Action: `Pass`
    - Interface:
    - Protocol: `Any`
    - Source: `[Interface Name] net` (z.B. `LAN net`)
    - Destination: `Alias: Local_Networks`
    - Gateway: `default` (Wichtig: KEINE Gateway-Gruppe hier auswählen!)
    - Description: "Allow local traffic bypass policy routing"  
        
3. **Darunter** platzieren Sie die Regel(n), die den Internetverkehr über die Failover-Gateway-Group leiten:
    - Action: `Pass`
    - Interface:
    - Protocol: `Any` (oder spezifischer, z.B. TCP/UDP)
    - Source: `[Interface Name] net` (z.B. `LAN net`)
    - Destination: `!` (not) `Alias: Local_Networks` (d.h., alles außer lokalen Netzen)
    - Gateway: `<Ihre_Failover_Gateway_Group>`
    - Description: "Allow Internet traffic via Failover Group"  
        

Diese Struktur stellt sicher, dass lokaler Verkehr die Policy-Routing-Regel umgeht und korrekt intern geroutet wird, während nur der externe Verkehr dem Failover-Mechanismus unterliegt.

### Erzwingung spezifischer Gateway-Nutzung

In manchen ZTA-Szenarien ist es erforderlich, dass bestimmter Traffic (z.B. von IoT-Geräten) _ausschließlich_ über ein spezifisches WAN-Gateway geleitet wird und bei dessen Ausfall blockiert wird, anstatt auf ein Failover-Gateway auszuweichen.

**Konfiguration:**

1. Erstellen Sie eine Regel, die den gewünschten Traffic über das spezifische WAN-Gateway leitet:
    - Action: `Pass`, Source: `<Geräte_Alias>`, Destination: `Any` (oder spezifischer), Gateway: `<Spezifisches_WAN_Gateway>`.  
        
2. Erstellen Sie **direkt darunter** eine Regel, die denselben Quellverkehr blockiert:
    - Action: `Block` (oder `Reject`), Source: `<Geräte_Alias>`, Destination: `Any`, Gateway: `default`.  
        
3. Aktivieren Sie die globale Option unter **System > Advanced > Miscellaneous > Gateway Monitoring > State Killing on Gateway Failure > Do not create rules when gateway is down**.  
    

Wenn nun das `<Spezifisches_WAN_Gateway>` ausfällt, wird die erste "Pass"-Regel aufgrund der globalen Einstellung ignoriert. Der Verkehr passt dann auf die zweite "Block"-Regel und wird blockiert, anstatt über ein anderes Gateway geleitet zu werden.

### State Table Handling im Failover und ZTA-Implikationen

Das Verhalten der pfSense State Table während eines WAN-Failovers ist kritisch für die Konsistenz der ZTA-Durchsetzung.

- **Problem:** Standardmäßig bleiben bestehende TCP-Verbindungen (und teilweise auch UDP-"Verbindungen") oft an das Gateway gebunden, über das sie ursprünglich aufgebaut wurden, selbst wenn dieses Gateway ausfällt oder das primäre Gateway nach einem Ausfall wieder online kommt. UDP-Verkehr ohne Sticky Connections könnte zwar den Pfad wechseln, aber TCP-States sind persistent. Dies kann dazu führen, dass:
    
    - Verbindungen auf einem ausgefallenen Gateway "hängen" bleiben und nicht funktionieren.
    - Verbindungen auf dem Failover-Gateway verbleiben, auch wenn das schnellere/günstigere primäre Gateway wieder verfügbar ist , was Kosten verursachen kann.  
        
    - ZTA-Richtlinien (z.B. spezifische IDS/IPS-Regeln oder Bandbreitenlimits auf dem primären Gateway) nicht greifen, weil der Verkehr weiterhin über das Failover-Gateway läuft.
    
     
    
- **Optionen in pfSense:**
    - **State Killing on Gateway Failure:** (**System > Advanced > Miscellaneous > State Killing on Gateway Failure**) Wenn aktiviert, löscht pfSense aktiv States, die einem als "down" markierten Gateway zugeordnet sind.
        
        - _ZTA-Vorteil:_ Erzwingt Neuaufbau von Verbindungen über ein _aktives_, definiertes Gateway, stellt Konnektivität sicher und sorgt dafür, dass der Verkehr den ZTA-Kontrollen des aktiven Pfades unterliegt.
        - _Nachteil:_ Unterbricht bestehende Sitzungen, was für Benutzer störend sein kann. Standardmäßig deaktiviert.  
            
        
         
        
    - **State Killing on Gateway Recovery (Failback):** Das automatische Löschen von States auf dem _Failover_-Gateway, wenn das _primäre_ Gateway wieder online kommt, um einen Failback zu erzwingen, ist komplexer.
        - **Gateway Group Option:** Unter **System > Routing > Gateway Groups > Edit Group** gibt es die Option **Keep Failover States**. Wenn diese auf "**Kill states on gateway recovery**" gesetzt wird, werden States, die _durch Policy Routing Regeln mit dieser spezifischen Gateway Group_ auf einem niedrigeren Tier (Failover-GW) erstellt wurden, gelöscht, wenn ein höheres Tier (primäres GW) wieder online kommt.  
            
        - _Einschränkung:_ Dies betrifft _nur_ States, die explizit durch Policy Routing mit dieser Gruppe erstellt wurden. Es funktioniert nicht für Traffic, der über das Default-Gateway geroutet wird, oder wenn die Option "Keep states on gateway recovery" (Standard) aktiv war und States auf dem Failover-GW verblieben sind. Das automatische Failback für _alle_ Verbindungen ist oft nur durch manuelles Löschen der States (**Diagnostics > States > Reset States** oder Aktionen unter **Status > Gateways** ) oder benutzerdefinierte Skripte zuverlässig erreichbar.  
            
        - _ZTA-Implikation:_ Das Fehlen eines robusten, automatischen Failback-Mechanismus für alle States bedeutet, dass ZTA-Richtlinien, die spezifisch für den primären Pfad gelten, möglicherweise nicht sofort nach dessen Wiederherstellung greifen. Dies muss bei der Planung berücksichtigt werden. Die Option "Kill states on gateway recovery" ist ein nützlicher Schritt, aber keine vollständige Lösung für alle Szenarien.
- **Sticky Connections:** (**System > Advanced > Miscellaneous > Use sticky connections**) Sorgt dafür, dass alle Verbindungen eines Clients (basierend auf Quell-IP) über dasselbe Gateway geleitet werden, auch bei Load Balancing.
    
    - _ZTA-Relevanz:_ Im reinen Failover-Szenario weniger kritisch. Bei Load Balancing kann es ZTA widersprechen, wenn nicht alle Pfade gleichwertig überwacht werden. Kann aber Kompatibilitätsprobleme mit Anwendungen verhindern, die IP-Wechsel nicht tolerieren. Bei Deaktivierung können TCP-Verbindungen länger auf dem Failover-Gateway verbleiben.  
        
    
     
    

Die folgende Tabelle fasst die Optionen zur Zustandsbehandlung und ihre Auswirkungen auf ZTA zusammen:

**Tabelle 3: State Handling Optionen in pfSense Multi-WAN und ZTA-Auswirkungen**

|Option|Konfigurationsort|Standard|ZTA-Vorteil|ZTA-Nachteil / Überlegung|
|:--|:--|:--|:--|:--|
|State Killing on Gateway Failure|System > Advanced > Misc > State Killing...|Deaktiviert|Stellt sicher, dass Traffic schnell über definierten, aktiven Pfad (mit ZTA-Kontrollen) läuft.|Unterbricht bestehende Sessions.|
|Keep Failover States (Keep states)|System > Routing > Gateway Groups > Edit Group|Aktiviert|Keine Unterbrechung von Sessions auf Failover-GW bei Wiederkehr des primären GW.|ZTA-Richtlinien des primären GW greifen evtl. nicht sofort; Traffic bleibt auf Failover-GW.|
|Keep Failover States (Kill states)|System > Routing > Gateway Groups > Edit Group|--|Erzwingt Failback für _Policy-Routing-States_ dieser Gruppe; ZTA-Richtlinien des primären GW greifen wieder.|Unterbricht Sessions auf Failover-GW; Funktioniert nicht für Default-GW-Traffic oder andere Gruppen.|
|Sticky Connections|System > Advanced > Misc > Use sticky connections|Aktiviert|Verhindert IP-Wechsel für Anwendungen bei Load Balancing.|Kann ZTA-konforme Lastverteilung behindern; Bei Deaktivierung bleiben TCP-States länger auf Failover-GW. Im reinen Failover weniger relevant.|

 

Die Integration von ZTA in eine Multi-WAN-Umgebung erfordert letztlich eine durchdachte Firewall-Regelarchitektur, die klar zwischen lokalem und externem Verkehr unterscheidet und Policy Routing gezielt einsetzt. Die explizite Konfiguration von Bypass-Regeln für interne Kommunikation ist unerlässlich, um die Mikrosegmentierung aufrechtzuerhalten. Gleichzeitig muss das Verhalten der State Table im Failover- und Failback-Szenario verstanden und die entsprechenden Optionen (insbesondere "State Killing" und "Keep Failover States") bewusst gewählt werden, um die Konsistenz der ZTA-Richtliniendurchsetzung im Rahmen der technischen Möglichkeiten von pfSense bestmöglich zu gewährleisten.  

## X. Zusammenfassung und Handlungsempfehlungen

### Zusammenfassung

Die Integration von Zero Trust Architecture (ZTA) in eine pfSense Multi-WAN-Umgebung stellt einen signifikanten Schritt zur Verbesserung der Netzwerksicherheit dar, erfordert jedoch eine Abkehr von traditionellen Konfigurationsansätzen. Dieser Bericht hat die Kernprinzipien der ZTA erläutert und aufgezeigt, wie spezifische pfSense-Funktionen und -Pakete zur Umsetzung dieser Prinzipien genutzt werden können.

Die wesentlichen Schritte umfassen:

1. **Definition der ZTA-Prinzipien:** Verständnis von "Never Trust, Always Verify", Least Privilege, Mikrosegmentierung, starker Authentifizierung und kontinuierlicher Überwachung im pfSense-Kontext.
2. **Nutzung von pfSense-Funktionen:** Systematisches Mapping von VLANs, granularen Firewall-Regeln, RADIUS/LDAP-Integration, Captive Portal, VPNs, IDS/IPS (Snort/Suricata) und Logging/Monitoring auf die ZTA-Anforderungen.
3. **Implementierung der Mikrosegmentierung:** Design von VLAN-Zonen basierend auf Funktion oder Vertrauensstufe und Durchsetzung der Segmentierung durch strikte "Default Deny" Inter-VLAN-Firewall-Regeln.
4. **Durchsetzung von Least Privilege:** Erstellung hochspezifischer Firewall-Regeln und Absicherung des Zugriffs auf die pfSense-Management-Schnittstelle selbst.
5. **Implementierung starker Authentifizierung:** Nutzung von Captive Portal mit RADIUS/LDAP, zertifikatsbasierter VPN-Authentifizierung (ggf. mit MFA via RADIUS) und potenziell 802.1X für portbasierte Kontrolle.
6. **Kontinuierliche Überprüfung:** Einsatz von IDS/IPS auf internen Schnittstellen zur Überwachung des Ost-West-Traffics und zur Erkennung lateraler Bewegungen.
7. **Gewährleistung der Transparenz:** Konfiguration umfassender Protokollierung und Weiterleitung der Logs an ein zentrales SIEM-System zur Analyse und Überwachung.
8. **Integration in Multi-WAN:** Sorgfältige Konfiguration von Policy Routing und Gateway Groups, Implementierung von Bypass-Regeln für lokalen Traffic und bewusstes Management der State-Table-Optionen ("State Killing", "Keep Failover States"), um die Konsistenz der ZTA-Richtlinien im Failover-Szenario zu gewährleisten.

Die Umsetzung erfordert ein Umdenken weg von implizitem Vertrauen hin zu expliziter Verifizierung und granularer Kontrolle auf allen Ebenen des Netzwerks.

### Handlungsempfehlungen

Die erfolgreiche Implementierung einer ZTA mit pfSense in einer Multi-WAN-Umgebung ist ein komplexes Unterfangen. Folgende Empfehlungen sollten berücksichtigt werden:

- **Phasenweise Implementierung:** Führen Sie ZTA schrittweise ein. Beginnen Sie beispielsweise mit der Mikrosegmentierung und den dazugehörigen Firewall-Regeln. Implementieren Sie anschließend stärkere Authentifizierungsmethoden und führen Sie zuletzt IDS/IPS ein, beginnend im Detection-Modus. Dies reduziert die Komplexität und erleichtert die Fehlersuche.
- **Sorgfältige Dokumentation:** Dokumentieren Sie die VLAN-Struktur, alle Firewall-Regeln (inklusive ihres Zwecks und der ZTA-Begründung), Alias-Definitionen, Konfigurationsentscheidungen bezüglich Authentifizierung und State Handling detailliert. Eine aktuelle Dokumentation ist für Wartung und Troubleshooting unerlässlich.
- **Umfassendes Testen:** Testen Sie jede Implementierungsphase gründlich. Überprüfen Sie die Konnektivität zwischen Segmenten gemäß den Firewall-Regeln. Testen Sie Authentifizierungsmechanismen. Simulieren Sie WAN-Failover-Szenarien und beobachten Sie das Verhalten der Verbindungen, die Konsistenz der Regeln und die IDS/IPS-Alerts. Überprüfen Sie die Logs auf erwartetes und unerwartetes Verhalten.
- **Regelmäßige Überprüfung und Anpassung:** ZTA ist kein einmaliges Projekt, sondern ein kontinuierlicher Prozess. Überprüfen Sie regelmäßig (z.B. quartalsweise oder jährlich) alle Firewall-Regeln, Benutzerberechtigungen, Alias-Definitionen und IDS/IPS-Signaturen/Suppress-Listen. Passen Sie die Konfiguration an neue Anforderungen, Bedrohungen oder erkannte Schwachstellen an, um die Einhaltung der ZTA-Prinzipien dauerhaft sicherzustellen.
- **Ausreichende Hardware-Dimensionierung:** Der Betrieb von IDS/IPS auf mehreren Interfaces, umfangreiches Logging und potenziell komplexe Firewall-Regelwerke können die Hardware-Anforderungen an die pfSense-Appliance erhöhen. Stellen Sie sicher, dass CPU, RAM und ggf. Festplattenspeicher ausreichend dimensioniert sind, um Performance-Engpässe zu vermeiden.  
    
- **Priorisierung:** Konzentrieren Sie sich bei der Implementierung zunächst auf die Absicherung der kritischsten Netzwerkzonen (z.B. Server-VLANs, Management-Zugänge) und der wichtigsten Kommunikationspfade.

Durch eine strukturierte Vorgehensweise, sorgfältige Planung und kontinuierliche Optimierung lässt sich die Sicherheit einer pfSense Multi-WAN-Umgebung mithilfe der Zero Trust Architecture signifikant erhöhen.